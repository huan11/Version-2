环境介绍：
实验环境有几个机器：堡垒机（bastion 控制openstak）、工具机（utilityvm 离线仓库位置）。生成的boottrap.ig拷贝到工具机，点火在堡垒机上触发。

================================================
首先在堡垒机上设置环境变量
[xiwei-redhat.com@bastion ~]$ ansible localhost -m lineinfile -a 'path=$HOME/.bashrc regexp="^export OCP_RELEASE" line="export OCP_RELEASE=4.5.3"'

localhost | CHANGED => {
    "backup": "",
    "changed": true,
    "msg": "line added"
}

[xiwei-redhat.com@bastion ~]$  source $HOME/.bashrc

下载oc cli：
[xiwei-redhat.com@bastion ~]$ wget https://mirror.openshift.com/pub/openshift-v4/clients/ocp/$OCP_RELEASE/openshift-client-linux-$OCP_RELEASE.tar.gz
--2020-07-27 02:02:02--  https://mirror.openshift.com/pub/openshift-v4/clients/ocp/4.5.3/openshift-client-linux-4.5.3.tar.gz
Resolving mirror.openshift.com (mirror.openshift.com)... 54.172.173.155, 54.173.18.88, 54.172.163.83
Connecting to mirror.openshift.com (mirror.openshift.com)|54.172.173.155|:443...connected.
HTTP request sent, awaiting response... 200 OK
Length: 25909584 (25M) [application/x-gzip]
Saving to: ‘openshift-client-linux-4.5.3.tar.gz’

100%[=====================================>] 25,909,584  28.3MB/s   in 0.9s

2020-07-27 02:02:03 (28.3 MB/s) - ‘openshift-client-linux-4.5.3.tar.gz’ saved [ 25909584/25909584]

也可以将openshift-install一并下载，主要openshift-install和OCP的版本镜像完全一致即可！没必要一定生成这个二进制：
wget https://mirror.openshift.com/pub/openshift-v4/clients/ocp/$OCP_RELEASE/openshift-install-linux-4.5.12.tar.gz

[xiwei-redhat.com@bastion ~]$ sudo tar xzf openshift-client-linux-$OCP_RELEASE.tar.gz -C /usr/local/sbin/ oc kubectl
[xiwei-redhat.com@bastion ~]$  which oc; oc version
/usr/local/sbin/oc
Client Version: 4.5.3

下载bash补全：
[xiwei-redhat.com@bastion ~]$ oc completion bash | sudo tee /etc/bash_completion.d/openshift > /dev/null
[xiwei-redhat.com@bastion ~]$  . /usr/share/bash-completion/bash_completion

查看openstack的认证文件，在openstack中的一个用户的项目中把该创建的资源都创建好。
[xiwei-redhat.com@bastion ~]$ cat $HOME/.config/openstack/clouds.yaml
clouds:
  36fd-project:
    auth:
      auth_url: "http://169.47.17.15:5000/v3"
      username: "36fd-user"
      project_name: "36fd-project"
      project_id: "c1432ed2c62b4b18bcaa402cc6be482d"
      user_domain_name: "Default"
      password: "AXwFK01JZF24"
    region_name: "regionOne"
    interface: "public"
    identity_api_version: 3

36fd-user是OpenStack的一个租户。


通过浏览器可以登录OpenStack的UI：
http://169.47.17.15/dashboard
详见OSP补充材料。

[xiwei-redhat.com@bastion ~]$  openstack server list    -f json
[
  {
    "ID": "2b2001c6-7757-4f8e-bcde-dd38192c96ca",
    "Name": "utilityvm",
    "Status": "ACTIVE",
    "Networks": "36fd-ocp-network=192.168.47.15",
    "Image": "",
    "Flavor": "2c2g30d"
  },
  {
    "ID": "71b91258-7c59-4d45-9f0b-4cd2042a63bf",
    "Name": "bastion",
    "Status": "ACTIVE",
    "Networks": "36fd-ocp-network=192.168.47.13, 52.116.95.208",
    "Image": "",
    "Flavor": "2c2g30d"
  }
]

============================================================
查看OpenStack环境中的vm：
[xiwei-redhat.com@bastion ~]$ echo $GUID
36fd
[xiwei-redhat.com@bastion ~]$ openstack server list
+--------------------------------------+-----------+--------+-----------------------------------------------+-------+---------+
| ID                                   | Name      | Status | Networks                                                                              | Image | Flavor  |
+--------------------------------------+-----------+--------+-----------------------------------------------+-------+---------+
| 2b2001c6-7757-4f8e-bcde-dd38192c96ca | utilityvm | ACTIVE | 36fd-ocp-network=                                        192.168.47.15                |       | 2c2g30d |
| 71b91258-7c59-4d45-9f0b-4cd2042a63bf | bastion   | ACTIVE | 36fd-ocp-network=                                        192.168.47.13, 52.116.95.208 |       | 2c2g30d |
+--------------------------------------+-----------+--------+----------------------------------------------+-------+---------+

查看网络：
[xiwei-redhat.com@bastion ~]$ openstack network list
+--------------------------------------+------------------+---------------------------------------------------------------------------------------------------                                        ---------------+
| ID                                   | Name             | Subnets                                                                                                                                                                                          |
+--------------------------------------+------------------+--------------------------------------------------------------------------------------------------                                        ---------------+
| 53c7a2c4-7fab-4720-9eec-57bae5c622fa | external         | 3a90520f-99d9-4291-                                        b46f-dd0aef63a3a8, e4dc2b97-1913-4f55-bfde-527f371973e7, f98c71e6-4531-4e03-8f9                                        b-d10ab48abb8c |
| 5c544d10-ab79-4c13-b160-dc9f094acb31 | 36fd-ocp-network | 35376056-4bec-4004-                                        923a-77b371d62c84                                                                                                                     |
+--------------------------------------+------------------+---------------------------------------------------------------------------------------------------                                        ---------------+

查看安全组：
[xiwei-redhat.com@bastion ~]$ openstack security group list
+--------------------------------------+------------------+--------------------------------------------------------------------------+------------------------                                        ----------+------+
| ID                                   | Name             | Description                                                                                                      | Project                                                                  | Tags |
+--------------------------------------+------------------+--------------------------------------------------------------------------+------------------------                                        ----------+------+
| 3b1ceb88-66a6-4388-960f-e6dc53805166 | 36fd-master_sg   | Security group for                                         OpenShift master and bootstrap                        | c1432ed2c62b4b18bcaa402                                        cc6be482d | []   |
| 3b8611c9-ec22-4fcd-8232-943073803742 | 36fd-utility_sg  | Utility security gr                                        oup allows SSH from bastion and egress to *           | c1432ed2c62b4b18bcaa402                                        cc6be482d | []   |
| 65214d3f-e210-4617-91fb-0486bf98336a | default          | Default security gr                                        oup                                                   | c1432ed2c62b4b18bcaa402                                        cc6be482d | []   |
| 6d4c29a2-46d0-4abb-aaf0-e466518cbaa7 | 36fd-worker_sg   | Security group for                                         OpenShift workers                                     | c1432ed2c62b4b18bcaa402                                        cc6be482d | []   |
| 7bcfa990-c505-485e-b57b-0f040720cda9 | 36fd-bastion_sg  | Bastion security gr                                        oup allows basic icmp and SSH ingress and egress to * | c1432ed2c62b4b18bcaa402                                        cc6be482d | []   |
| 9dd22c4b-4850-4954-871a-f693719c6f36 | 36fd-isolated_sg | All instances in th                                        e disconnected network                                | c1432ed2c62b4b18bcaa402                                        cc6be482d | []   |
+--------------------------------------+------------------+--------------------------------------------------------------------------+------------------------                                        ----------+------+

查看子网：
[xiwei-redhat.com@bastion ~]$  openstack subnet show $GUID-ocp-subnet -f json
{
  "allocation_pools": [
    {
      "start": "192.168.47.10",
      "end": "192.168.47.254"
    }
  ],
  "cidr": "192.168.47.0/24",
  "created_at": "2020-07-27T05:38:52Z",
  "description": "",
  "dns_nameservers": [],
  "enable_dhcp": true,
  "gateway_ip": "192.168.47.1",
  "host_routes": [],
  "id": "35376056-4bec-4004-923a-77b371d62c84",
  "ip_version": 4,
  "ipv6_address_mode": null,
  "ipv6_ra_mode": null,
  "location": {
    "cloud": "36fd-project",
    "region_name": "regionOne",
    "zone": null,
    "project": {
      "id": "c1432ed2c62b4b18bcaa402cc6be482d",
      "name": "36fd-project",
      "domain_id": "default",
      "domain_name": null
    }
  },
  "name": "36fd-ocp-subnet",
  "network_id": "5c544d10-ab79-4c13-b160-dc9f094acb31",
  "prefix_length": null,
  "project_id": "c1432ed2c62b4b18bcaa402cc6be482d",
  "revision_number": 0,
  "segment_id": null,
  "service_types": [],
  "subnetpool_id": null,
  "tags": [],
  "updated_at": "2020-07-27T05:38:52Z"
}



=============================================================
Deploy Container Registry 创建离线仓库
[xiwei-redhat.com@bastion ~]$ ssh utilityvm.example.com
Warning: Permanently added 'utilityvm.example.com,192.168.47.15' (ECDSA) to the list of known hosts.
Last login: Mon Jul 27 01:55:52 2020 from 192.168.47.13

尝试获取镜像：
[cloud-user@utilityvm ~]$ podman pull ubi7/ubi:7.7
Trying to pull registry.access.redhat.com/ubi7/ubi:7.7...Getting image source signatures
Copying blob 09dbbf8834d2 done
Copying blob fcd63ccfdd0c done
 podman run ubi7/ubi:7.7 cat /etc/os-releaseCopying config 0355cd652b [======================================] 4.3KiB /Copying config 0355cd652b done
Writing manifest to image destination
Storing signatures

0355cd652bd1c4afd8d8f2cd8d0a4887196cb4808b8f803e146ec266ecdd5aa2
[cloud-user@utilityvm ~]$  podman run ubi7/ubi:7.7 cat /etc/os-release
NAME="Red Hat Enterprise Linux Server"
VERSION="7.7 (Maipo)"
ID="rhel"
ID_LIKE="fedora"
VARIANT="Server"
VARIANT_ID="server"
VERSION_ID="7.7"
PRETTY_NAME="Red Hat Enterprise Linux Server 7.7 (Maipo)"
ANSI_COLOR="0;31"
CPE_NAME="cpe:/o:redhat:enterprise_linux:7.7:GA:server"
HOME_URL="https://www.redhat.com/"
BUG_REPORT_URL="https://bugzilla.redhat.com/"

REDHAT_BUGZILLA_PRODUCT="Red Hat Enterprise Linux 7"
REDHAT_BUGZILLA_PRODUCT_VERSION=7.7
REDHAT_SUPPORT_PRODUCT="Red Hat Enterprise Linux"
REDHAT_SUPPORT_PRODUCT_VERSION="7.7"

创建离线仓库：
[cloud-user@utilityvm ~]$ sudo mkdir -p /opt/registry/{auth,certs,data}
[cloud-user@utilityvm ~]$ sudo chown -R $USER /opt/registry
[cloud-user@utilityvm ~]$ cd /opt/registry/certs


生成证书：
[cloud-user@utilityvm certs]$ openssl req -newkey rsa:4096 -nodes -sha256 -keyout domain.key -x509 -days 365 -out domain.crt
Generating a 4096 bit RSA private key
....................................................++
.......................................................................................................................++
writing new private key to 'domain.key'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [XX]:CN
State or Province Name (full name) []:CN
Locality Name (eg, city) [Default City]:CN
Organization Name (eg, company) [Default Company Ltd]:CN
Organizational Unit Name (eg, section) []:CN
Common Name (eg, your name or your server's hostname) []:utilityvm.example.com
Email Address []:

生成仓库的用户名、密码：
[cloud-user@utilityvm certs]$  htpasswd -bBc /opt/registry/auth/htpasswd openshift redhat
Adding password for user openshift

启动离线仓库：
[cloud-user@utilityvm certs]$ podman run -d --name mirror-registry \
>     -p 5000:5000 --restart=always \
>     -v /opt/registry/data:/var/lib/registry:z \
>     -v /opt/registry/auth:/auth:z \
>     -e "REGISTRY_AUTH=htpasswd" \
>     -e "REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm" \
>     -e "REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd" \
>     -v /opt/registry/certs:/certs:z \
>     -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \
>     -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key \
>     docker.io/library/registry:2
Trying to pull docker.io/library/registry:2...Getting image source signatures
Copying blob cbdbe7a5bc2a done
Copying blob 46bcb632e506 done
Copying blob 3db6272dcbfa done
Copying blob 47112e65547d done
Copying blob c1cc712bcecd done
Copying config 2d4f4b5309 done
Writing manifest to image destination
Storing signatures
96911df51154b2e64f9f7a2478f87ad68a80d3cdb8ef9fe9518f865638ef518e


确认仓库可访问：
[cloud-user@utilityvm certs]$  curl -u openshift:redhat -k https://utilityvm.example.com:5000/v2/_catalog
{"repositories":[]}

通过TLS检查
[cloud-user@utilityvm certs]$ curl -u openshift:redhat https://utilityvm.example.com:5000/v2/_catalog
curl: (60) Peer's certificate issuer has been marked as not trusted by the user.
More details here: http://curl.haxx.se/docs/sslcerts.html

curl performs SSL certificate verification by default, using a "bundle"
 of Certificate Authority (CA) public keys (CA certs). If the default
 bundle file isn't adequate, you can specify an alternate file
 using the --cacert option.
If this HTTPS server uses a certificate signed by a CA represented in
 the bundle, the certificate verification probably failed due to a
 problem with the certificate (it might be expired, or the name might
 not match the domain name in the URL).
If you'd like to turn off curl's verification of the certificate, use
 the -k (or --insecure) option.

拷贝证书，确保本机可以tls访问仓库：
[cloud-user@utilityvm certs]$ sudo cp /opt/registry/certs/domain.crt /etc/pki/ca-trust/source/anchors/
[cloud-user@utilityvm certs]$  sudo update-ca-trust
[cloud-user@utilityvm certs]$  curl -u openshift:redhat https://utilityvm.example.com:5000/v2/_catalog
{"repositories":[]}
[cloud-user@utilityvm certs]$



测试推拉镜像正常
$ podman pull ubi7/ubi:7.7
$ podman login -u openshift -p redhat utilityvm.example.com:5000
$ podman tag registry.access.redhat.com/ubi7/ubi:7.7 utilityvm.example.com:5000/ubi7/ubi:7.7
$ podman push utilityvm.example.com:5000/ubi7/ubi:7.7


pull一个镜像，打完tag推到离线仓库进行测试：
[cloud-user@utilityvm certs]$ podman pull ubi7/ubi:7.7
Trying to pull registry.access.redhat.com/ubi7/ubi:7.7...Getting image source signatures
Copying blob 09dbbf8834d2 skipped: already exists
Copying blob fcd63ccfdd0c skipped: already exists
Copying config 0355cd652b done
Writing manifest to image destination
Storing signatures
0355cd652bd1c4afd8d8f2cd8d0a4887196cb4808b8f803e146ec266ecdd5aa2


[cloud-user@utilityvm certs]$ podman login -u openshift -p redhat utilityvm.example.com:5000
Login Succeeded!

[cloud-user@utilityvm certs]$ podman tag registry.access.redhat.com/ubi7/ubi:7.7 utilityvm.example.com:5000/ubi7/ubi:7.7
[cloud-user@utilityvm certs]$ podman push utilityvm.example.com:5000/ubi7/ubi:7.7
Getting image source signatures
Copying blob ac7577b8c383 done
Copying blob 5601485f0109 done
Copying config 0355cd652b done
Writing manifest to image destination
Storing signatures


查看镜像已经push成功：
[cloud-user@utilityvm certs]$ ls /opt/registry/data/docker/registry/v2/repositories
ubi7

接下来的操作，在堡垒机完成。
[xiwei-redhat.com@bastion ~]$ sudo scp utilityvm.example.com:/opt/registry/certs/domain.crt /etc/pki/ca-trust/source/anchors/
Warning: Permanently added 'utilityvm.example.com,192.168.47.18' (ECDSA) to the list of known hosts.
domain.crt                                                                           100% 2143     1.3MB/s   00:00
[xiwei-redhat.com@bastion ~]$  sudo update-ca-trust
[xiwei-redhat.com@bastion ~]$ curl -u openshift:redhat https://utilityvm.example.com:5000/v2/_catalog
{"repositories":["ubi7/ubi"]}
[xiwei-redhat.com@bastion ~]$ podman login -u openshift -p redhat --authfile $HOME/pullsecret_config.json
Error: please specify a registry to login to
[xiwei-redhat.com@bastion ~]$  podman login -u openshift -p redhat --authfile $HOME/pullsecret_config.json utilityvm.example.com:5000
Login Succeeded!
[xiwei-redhat.com@bastion ~]$  echo '<your-openshift-pull-secret-in-json>' > $HOME/ocp_pullsecret.json
[xiwei-redhat.com@bastion ~]$ jq -c --argjson var "$(jq .auths $HOME/pullsecret_config.json)" '.auths += $var' $HOME/ocp_pullsecret.json > merged_pullsecret.json
parse error: Invalid numeric literal at line 2, column 0
[xiwei-redhat.com@bastion ~]$ sudo yum -y install https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
Loaded plugins: search-disabled-repos
epel-release-latest-7.noarch.rpm                                                                |  15 kB  00:00:00
Examining /var/tmp/yum-root-dNFgNt/epel-release-latest-7.noarch.rpm: epel-release-7-12.noarch
Marking /var/tmp/yum-root-dNFgNt/epel-release-latest-7.noarch.rpm to be installed
Resolving Dependencies
--> Running transaction check
---> Package epel-release.noarch 0:7-12 will be installed
--> Finished Dependency Resolution

Dependencies Resolved

=======================================================================================================================
 Package                    Arch                 Version             Repository                                   Size
=======================================================================================================================
Installing:
 epel-release               noarch               7-12                /epel-release-latest-7.noarch                24 k

Transaction Summary
=======================================================================================================================
Install  1 Package

Total size: 24 k
Installed size: 24 k
Downloading packages:
Running transaction check
Running transaction test
Transaction test succeeded
Running transaction
  Installing : epel-release-7-12.noarch                                                                            1/1
  Verifying  : epel-release-7-12.noarch                                                                            1/1

Installed:
  epel-release.noarch 0:7-12

Complete!
[xiwei-redhat.com@bastion ~]$ sudo yum install jq -y
Loaded plugins: search-disabled-repos
epel/x86_64/metalink                                                                            |  18 kB  00:00:00
epel                                                                                            | 4.7 kB  00:00:00
(1/3): epel/x86_64/updateinfo                                                                   | 1.0 MB  00:00:00
(2/3): epel/x86_64/group_gz                                                                     |  95 kB  00:00:00
(3/3): epel/x86_64/primary_db                                                                   | 6.9 MB  00:00:01
Resolving Dependencies
--> Running transaction check
---> Package jq.x86_64 0:1.6-2.el7 will be installed
--> Processing Dependency: libonig.so.5()(64bit) for package: jq-1.6-2.el7.x86_64
--> Running transaction check
---> Package oniguruma.x86_64 0:6.8.2-1.el7 will be installed
--> Finished Dependency Resolution

Dependencies Resolved

=======================================================================================================================
 Package                      Arch                      Version                          Repository               Size
=======================================================================================================================
Installing:
 jq                           x86_64                    1.6-2.el7                        epel                    167 k
Installing for dependencies:
 oniguruma                    x86_64                    6.8.2-1.el7                      epel                    181 k

Transaction Summary
=======================================================================================================================
Install  1 Package (+1 Dependent package)

Total download size: 348 k
Installed size: 1.0 M
Downloading packages:
warning: /var/cache/yum/x86_64/7Server/epel/packages/jq-1.6-2.el7.x86_64.rpm: Header V3 RSA/SHA256 Signature, key ID 352c64e5: NOKEY
Public key for jq-1.6-2.el7.x86_64.rpm is not installed
(1/2): jq-1.6-2.el7.x86_64.rpm                                                                  | 167 kB  00:00:00
(2/2): oniguruma-6.8.2-1.el7.x86_64.rpm                                                         | 181 kB  00:00:00
-----------------------------------------------------------------------------------------------------------------------
Total                                                                                  442 kB/s | 348 kB  00:00:00
Retrieving key from file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7
Importing GPG key 0x352C64E5:
 Userid     : "Fedora EPEL (7) <epel@fedoraproject.org>"
 Fingerprint: 91e9 7d7c 4a5e 96f1 7f3e 888f 6a2f aea2 352c 64e5
 Package    : epel-release-7-12.noarch (@/epel-release-latest-7.noarch)
 From       : /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7
Running transaction check
Running transaction test
Transaction test succeeded
Running transaction
  Installing : oniguruma-6.8.2-1.el7.x86_64                                                                        1/2
  Installing : jq-1.6-2.el7.x86_64                                                                                 2/2
  Verifying  : oniguruma-6.8.2-1.el7.x86_64                                                                        1/2
  Verifying  : jq-1.6-2.el7.x86_64                                                                                 2/2

Installed:
  jq.x86_64 0:1.6-2.el7

Dependency Installed:
  oniguruma.x86_64 0:6.8.2-1.el7

Complete!
[xiwei-redhat.com@bastion ~]$ jq . merged_pullsecret.json
[xiwei-redhat.com@bastion ~]$ jq . merged_pullsecret.json
[xiwei-redhat.com@bastion ~]$ cat   merged_pullsecret.json
[xiwei-redhat.com@bastion ~]$  jq -c --argjson var "$(jq .auths $HOME/pullsecret_config.json)" '.auths += $var' $HOME/ocp_pullsecret.json > merged_pullsecret.json
parse error: Invalid numeric literal at line 2, column 0
[xiwei-redhat.com@bastion ~]$ cat $HOME/pullsecret_config.json
{
        "auths": {
                "utilityvm.example.com:5000": {
                        "auth": "b3BlbnNoaWZ0OnJlZGhhdA=="
                }
        }
}[xiwei-redhat.com@bastion ~]$ pwd
/home/xiwei-redhat.com
[xiwei-redhat.com@bastion ~]$ vi 1.json
[xiwei-redhat.com@bastion ~]$ jq -c --argjson var "$(jq .auths $HOME/pullsecret_config.json)" '.auths += $var'  ~/1.json > merged_pullsecret.json
[xiwei-redhat.com@bastion ~]$ jq . merged_pullsecret.json
{
  "auths": {
    "cloud.openshift.com": {
      "auth": "b3BlbnNoaWZ0LXJlbGVhc2UtZGV2K3hpVpcmVkaGF0Y29tMWdxeHc3ZzdzYnlwcWxseXUxZGowOWNvY2FiOkxMMlFSVzZXVUpQQ1NZOVVSOTM2T1JZTkpQWkowT1NJWlgwMTdXTkM5VTlVVDFTR0pURTZNWkpNSVkwUUtQNFA=",
      "email": "xiwei@redhat.com"
    },
    "quay.io": {
      "auth": "b3BlbnNoaWZ0LXJlbGVhGV2K3hpd2VpcmVkaGF0Y29tMWdxeHc3ZzdzYnlwcWxseXUxZGowOWNvY2FiOkxMMlFSVzZXVUpQQ1NZOVVSOTM2T1JZTkpQWkowT1NJWlgwMTdXTkM5VTlVVDFTR0pURTZNWkpNSVkwUUtQNFA=",
      "email": "xiwei@redhat.com"
    },
    "registry.connect.redhat.com": {
      "auth": "Nzk4NTAzOHx1aGMtM3RzdTQllQUWxsWXUxRGowOUNvQ0FCOmV5SmhiR2NpT2lKU1V6VXhNaUo5LmV5SnpkV0lpT2lJMllXSmpPR0ZpTXpRMU9EYzBOamN3WVRVd1pqWm1NamxrT0dKallqa3dZaUo5LlBONFdTRkdRLTZ1Q1lER2ZJM3RLR3ZyYnlHU1dqVGppZVhDRC1vbjhpMXUxN29YeG9tS09yd20xbjlLbXlvZk80b1pfaEoydnlmZ2VySTdaLVpBSDJiRU5janlWV3h5aEcyQVowRzJLa0VtZk1QT1hQRlVXRjZQSTJaWWd2RXdlT0k2ZzgxR0Nvbm9wLUdZSkVJaXlGenkxVms3d0tMbURfSGVmV1c1X05oTzlBNEY3MUpid3JTeTNRa3V3cUp3cjhIRWlmdUdyOHJKdGZRb2ZFdElYVUVsMm0wSkZoaGV6WFFJeHI5aFlXNXhnMnFpV19VSFY0VjZvRkZjUVF2VDg2SXVIeWNBV1BEVUlKdzdjNnZDdk0wa1E5T2NNZEtBc1NIZ3JRMUdVTTU0NW5SeXBZSFVXMTN0Mk11bWRNYnhmc1FQTEFEa3RfdFI4UThOTk1QWml0YURMT3pqQTV0aVhua0IzUFlfUDBicTUtRnhrNnFUYTBFdEs3RWRRVUlJemJaSldsek9fZkVlanBZaHZ0dWktUnp4QUFZSnpILTFlNGExNTlJSGdWdG9lZkZCMzdldW9MYjZNcWs1RmJWX1FKZ0RzYnc3UVA3WEJVX1I2blRPcUV4M0lnQ1RVSGVmdGRQakFJQzdPWGs5U0dzTko0NkhkOUpDRDFmb1Y2TlpVQ0hJcUFWQm1IeU16YzhpMUJ1RmRsZFFQRGFfakFEbGVPZXBrM3ZpWVItaEdUQU82N2Y5X29wa1Zia3V6bXRoVnNwMlczTzF6ZUZ0UVh3a3FRMThFdHlQcHhzSWRyUEV5bTRhcEVRdFJYZFlQZ0czVmJBR0E4NTdGak90OUx0c3B6dlphNFBCV1lxSHVDcjUwLUNzY3NKVmlPTmw2ZW9OVEw0",
      "email": "xiwei@redhat.com"
    },
    "registry.redhat.io": {
      "auth": "Nzk4NTAzOHx1aGMtMUdxeFc3RzdTQllQUWxsWXUxRGowOUNvQ0FCOmV5SmhiR2NpT2lKU1V6VXhNaUo5LmV5SnpkV0lpT2lJMllXSmpPR0ZpTXpRMU9EYzBOamN3WVRVd1pqWm1NamxrT0dKallqa3dZaUo5LlBONFdTRkdRLTZ1Q1lER2ZJM3RLR3ZyYnlHU1dqVGppZVhDRC1vbjhpMXUxN29YeG9tS09yd20xbjlLbXlvZk80b1pfaEoydnlmZ2VySTdaLVpBSDJiRU5janlWV3h5aEcyQVowRzJLa0VtZk1QT1hQRlVXRjZQSTJaWWd2RXdlT0k2ZzgxR0Nvbm9wLUdZSkVJaXlGenkxVms3d0tMbURfSGVmV1c1X05oTzlBNEY3MUpid3JTeTNRa3V3cUp3cjhIRWlmdUdyOHJKdGZRb2ZFdElYVUVsMm0wSkZoaGV6WFFJeHI5aFlXNXhnMnFpV19VSFY0VjZvRkZjUVF2VDg2SXVIeWNBV1BEVUlKdzdjNnZDdk0wa1E5T2NNZEtBc1NIZ3JRMUdVTTU0NW5SeXBZSFVXMTN0Mk11bWRNYnhmc1FQTEFEa3RfdFI4UThOTk1QWml0YURMT3pqQTV0aVhua0IzUFlfUDBicTUtRnhrNnFUYTBFdEs3RWRRVUlJemJaSldsek9fZkVlanBZaHZ0dWktUnp4QUFZSnpILTFlNGExNTlJSGdWdG9lZkZCMzdldW9MYjZNcWs1RmJWX1FKZ0RzYnc3UVA3WEJVX1I2blRPcUV4M0lnQ1RVSGVmdGRQakFJQzdPWGs5U0dzTko0NkhkOUpDRDFmb1Y2TlpVQ0hJcUFWQm1IeU16YzhpMUJ1RmRsZFFQRGFfakFEbGVPZXBrM3ZpWVItaEdUQU82N2Y5X29wa1Zia3V6bXRoVnNwMlczTzF6ZUZ0UVh3a3FRMThFdHlQcHhzSWRyUEV5bTRhcEVRdFJYZFlQZ0czVmJBR0E4NTdGak90OUx0c3B6dlphNFBCV1lxSHVDcj2Y3NKVmlPTmw2ZW9OVEw0",
      "email": "xiwei@redhat.com"
    },
    "utilityvm.example.com:5000": {
      "auth": "b3BlbnNoaWZ0OnJlZGhhdA=="
    }
  }
}




设置堡垒机的环境变量：
ansible localhost -m lineinfile -a 'path=$HOME/.bashrc regexp="^export LOCAL_REGISTRY" line="export LOCAL_REGISTRY=utilityvm.example.com:5000"'
ansible localhost -m lineinfile -a 'path=$HOME/.bashrc regexp="^export LOCAL_REPOSITORY" line="export LOCAL_REPOSITORY=ocp4/openshift4"'
 ansible localhost -m lineinfile -a 'path=$HOME/.bashrc regexp="^export LOCAL_SECRET_JSON" line="export LOCAL_SECRET_JSON=$HOME/merged_pullsecret.json"'
ansible localhost -m lineinfile -a 'path=$HOME/.bashrc regexp="^export PRODUCT_REPO" line="export PRODUCT_REPO=openshift-release-dev"'
ansible localhost -m lineinfile -a 'path=$HOME/.bashrc regexp="^export RELEASE_NAME" line="export RELEASE_NAME=ocp-release"'
ansible localhost -m lineinfile -a 'path=$HOME/.bashrc regexp="^export ARCHITECTURE" line="export ARCHITECTURE=x86_64"'
source $HOME/.bashrc

LOCAL_REGISTRY is the container registry you installed on your Utility VM. If you were doing this in another environment, it would be the container registry that you want to mirror the container images to.

LOCAL_REPOSITORY is the repository and image name that you want to push the images to. You should choose something descriptive here, but the choice is yours.

LOCAL_SECRET_JSON is the merged pull secret you created. This pull secret containers credentials to pull the OpenShift images and push them to your local container registry. This must be set to the absolute path.

PRODUCT_REPO is the repository you are mirroring the images from. Do not change this.

RELEASE_NAME refers to the images your will be pulling. Do not change this.

ARCHITECTURE is the architecture of the server, such as x86_64. Do not change this.


在堡垒机上缓存镜像：
oc adm -a ${LOCAL_SECRET_JSON} release mirror \
     --from=quay.io/${PRODUCT_REPO}/${RELEASE_NAME}:${OCP_RELEASE}-${ARCHITECTURE} \
     --to=${LOCAL_REGISTRY}/${LOCAL_REPOSITORY} \
     --to-release-image=${LOCAL_REGISTRY}/${LOCAL_REPOSITORY}:${OCP_RELEASE}-${ARCHITECTURE}

Success
Update image:  utilityvm.example.com:5000/ocp4/openshift4:4.5.3-x86_64
Mirror prefix: utilityvm.example.com:5000/ocp4/openshift4

To use the new mirrored repository to install, add the following section to the install-config.yaml:

imageContentSources:
- mirrors:
  - utilityvm.example.com:5000/ocp4/openshift4
  source: quay.io/openshift-release-dev/ocp-release
- mirrors:
  - utilityvm.example.com:5000/ocp4/openshift4
  source: quay.io/openshift-release-dev/ocp-v4.0-art-dev


To use the new mirrored repository for upgrades, use the following to create an ImageContentSourcePolicy:

apiVersion: operator.openshift.io/v1alpha1
kind: ImageContentSourcePolicy
metadata:
  name: example
spec:
  repositoryDigestMirrors:
  - mirrors:
    - utilityvm.example.com:5000/ocp4/openshift4
    source: quay.io/openshift-release-dev/ocp-release
  - mirrors:
    - utilityvm.example.com:5000/ocp4/openshift4
    source: quay.io/openshift-release-dev/ocp-v4.0-art-dev



拉取一个镜像进行尝试：
[xiwei-redhat.com@bastion ~]$ podman pull --authfile $HOME/pullsecret_config.json utilityvm.example.com:5000/ocp4/openshift4:4.5.3-operator-lifecycle-manager
Trying to pull utilityvm.example.com:5000/ocp4/openshift4:4.5.3-operator-lifecycle-manager...Getting image source signatures
Copying blob ec4ff9475976 done
Copying blob bb0da44cdbce done
Copying blob 9b199159ccc9 done
Copying blob a03401a44180 done
Copying blob 521e7401c9c8 done
Copying config 99bdeb6f3c done
Writing manifest to image destination
Storing signatures
99bdeb6f3c4f6207deb6bc948d6a09e774e0dcffe5796807aab4503bfed30c67


[xiwei-redhat.com@bastion ~]$  podman images
REPOSITORY                                   TAG                                IMAGE ID       CREATED        SIZE
utilityvm.example.com:5000/ocp4/openshift4   4.5.3-operator-lifecycle-manager   99bdeb6f3c4f   9 days ago     472 MB
registry.access.redhat.com/ubi7/ubi          7.7                                0355cd652bd1   4 months ago   215 MB

确认离线仓库镜像的版本：
[xiwei-redhat.com@bastion ~]$ oc adm release info -a ${LOCAL_SECRET_JSON} "${LOCAL_REGISTRY}/${LOCAL_REPOSITORY}:${OCP_RELEASE}-${ARCHITECTURE}" | head -n 18
Name:      4.5.3
Digest:    sha256:eab93b4591699a5a4ff50ad3517892653f04fb840127895bb3609b3cc68f98f3
Created:   2020-07-21T06:25:58Z
OS/Arch:   linux/amd64
Manifests: 419

Pull From: utilityvm.example.com:5000/ocp4/openshift4@sha256:eab93b4591699a5a4ff50ad3517892653f04fb840127895bb3609b3cc68f98f3

Release Metadata:
  Version:  4.5.3
  Upgrades: 4.4.10, 4.4.11, 4.4.12, 4.4.13, 4.4.14, 4.4.15, 4.5.1, 4.5.2
  Metadata:
    description:
  Metadata:
    url: https://access.redhat.com/errata/RHBA-2020:2956

Component Versions:
  kubernetes 1.18.3
[xiwei-redhat.com@bastion ~]$


和quay.io的版本进行对比：
[xiwei-redhat.com@bastion ~]$  oc adm release info -a ${LOCAL_SECRET_JSON} "quay.io/${PRODUCT_REPO}/${RELEASE_NAME}:${OCP_RELEASE}-${ARCHITECTURE}" | head -n 18
Name:      4.5.3
Digest:    sha256:eab93b4591699a5a4ff50ad3517892653f04fb840127895bb3609b3cc68f98f3
Created:   2020-07-21T06:25:58Z
OS/Arch:   linux/amd64
Manifests: 419

Pull From: quay.io/openshift-release-dev/ocp-release@sha256:eab93b4591699a5a4ff50ad3517892653f04fb840127895bb3609b3cc68f98f3

Release Metadata:
  Version:  4.5.3
  Upgrades: 4.4.10, 4.4.11, 4.4.12, 4.4.13, 4.4.14, 4.4.15, 4.5.1, 4.5.2
  Metadata:
    description:
  Metadata:
    url: https://access.redhat.com/errata/RHBA-2020:2956

Component Versions:
  kubernetes 1.18.3


生成openshift-install二进制文件：

[xiwei-redhat.com@bastion ~]$ oc adm release extract -a ${LOCAL_SECRET_JSON} --command=openshift-install "${LOCAL_REGISTRY}/${LOCAL_REPOSITORY}:${OCP_RELEASE}-${ARCHITECTURE}"
[xiwei-redhat.com@bastion ~]$  ls -l
total 549544
-rw-r--r--. 1 xiwei-redhat.com users      2731 Jul 27 04:32 1.json
drwxrwxr-x. 6 xiwei-redhat.com root        105 Jul 27 04:11 certbot
drwxrwxr-x. 2 xiwei-redhat.com root         79 Jul 27 04:11 certificates
-rw-r--r--. 1 xiwei-redhat.com users      2796 Jul 27 04:33 merged_pullsecret.json
-rw-r--r--. 1 xiwei-redhat.com users        37 Jul 27 04:30 ocp_pullsecret.json
-rw-r--r--. 1 xiwei-redhat.com users  25909584 Jul 17 17:39 openshift-client-linux-4.5.3.tar.gz
-rwxr-xr-x. 1 xiwei-redhat.com users 368259072 Jul 17 17:39 openshift-install
drwxr-xr-x. 2 xiwei-redhat.com users         6 Jul 27 04:51 openstack-upi
-rwxr-xr-x. 1 xiwei-redhat.com users        94 Jul 27 04:30 pullsecret_config.json
drwxr--r--. 2 xiwei-redhat.com users       127 Jul 27 04:09 resources
drwxr-xr-x. 3 xiwei-redhat.com users        21 Jul 27 04:10 virtualenvs
[xiwei-redhat.com@bastion ~]$  sudo mv openshift-install /usr/local/sbin/
[xiwei-redhat.com@bastion ~]$ openshift-install version
openshift-install 4.5.3
built from commit 01f5643a02f154246fab0923f8828aa9ae3b76fb
release image utilityvm.example.com:5000/ocp4/openshift4@sha256:eab93b4591699a5a4ff50ad3517892653f04fb840127895bb3609b3cc68f98f3
[xiwei-redhat.com@bastion ~]$




[xiwei-redhat.com@bastion openstack-upi]$ echo $API_FIP
52.116.95.177
[xiwei-redhat.com@bastion openstack-upi]$ echo $OPENSHIFT_DNS_ZONE
blue.osp.opentlc.com
[xiwei-redhat.com@bastion openstack-upi]$  cat $HOME/merged_pullsecret.json
{"auths":{"cloud.openshift.com":{"auth":"b3BlbnNoaWZ0LXJlbGVhc2UtZGV2K3hpd2VpcmVkaGF0Y29tMWdxeHc3ZzdzYnlwcWxseXUxZGowOWNvY2FiOkxMMlFSVzZXVUpQQ1NZOVVSOTM2T1JZTkpQWkowT1NJWlgwMTdXTkM5VTlVVDFTR0pURTZNWkpNSVkwUUtQNFA=","email":"xiwei@redhat.com"},"quay.io":{"auth":"b3BlbnNoaWZ0LXJlbGVhc2UtZGV2K3hpd2VpcmVkaGF0Y29tMWdxeHc3ZzdzYnlwcWxseXUxZGowOWNvY2FiOkxMMlFSVzZXVUpQQ1NZOVVSOTM2T1JZTkpQWkowT1NJWlgwMTdXTkM5VTlVVDFTR0pURTZNWkpNSVkwUUtQNFA=","email":"xiwei@redhat.com"},"registry.connect.redhat.com":{"auth":"Nzk4NTAzOHx1aGMtMUdxeFc3RzdTQllQUWxsWXUxRGowOUNvQ0FCOmV5SmhiR2NpT2lKU1V6VXhNaUo5LmV5SnpkV0lpT2lJMllXSmpPR0ZpTXpRMU9EYzBOamN3WVRVd1pqWm1NamxrT0dKallqa3dZaUo5LlBONFdTRkdRLTZ1Q1lER2ZJM3RLR3ZyYnlHU1dqVGppZVhDRC1vbjhpMXUxN29YeG9tS09yd20xbjlLbXlvZk80b1pfaEoydnlmZ2VySTdaLVpBSDJiRU5janlWV3h5aEcyQVowRzJLa0VtZk1QT1hQRlVXRjZQSTJaWWd2RXdlT0k2ZzgxR0Nvbm9wLUdZSkVJaXlGenkxVms3d0tMbURfSGVmV1c1X05oTzlBNEY3MUpid3JTeTNRa3V3cUp3cjhIRWlmdUdyOHJKdGZRb2ZFdElYVUVsMm0wSkZoaGV6WFFJeHI5aFlXNXhnMnFpV19VSFY0VjZvRkZjUVF2VDg2SXVIeWNBV1BEVUlKdzdjNnZDdk0wa1E5T2NNZEtBc1NIZ3JRMUdVTTU0NW5SeXBZSFVXMTN0Mk11bWRNYnhmc1FQTEFEa3RfdFI4UThOTk1QWml0YURMT3pqQTV0aVhua0IzUFlfUDBicTUtRnhrNnFUYTBFdEs3RWRRVUlJemJaSldsek9fZkVlanBZaHZ0dWktUnp4QUFZSnpILTFlNGExNTlJSGdWdG9lZkZCMzdldW9MYjZNcWs1RmJWX1FKZ0RzYnc3UVA3WEJVX1I2blRPcUV4M0lnQ1RVSGVmdGRQakFJQzdPWGs5U0dzTko0NkhkOUpDRDFmb1Y2TlpVQ0hJcUFWQm1IeU16YzhpMUJ1RmRsZFFQRGFfakFEbGVPZXBrM3ZpWVItaEdUQU82N2Y5X29wa1Zia3V6bXRoVnNwMlczTzF6ZUZ0UVh3a3FRMThFdHlQcHhzSWRyUEV5bTRRdFJYZFlQZ0czVmJBR0E4NTdGak90OUx0c3B6dlphNFBCV1lxSHVDcjUwLUNzcS1JTHQ5bm92Y3NKVmlPTmw2ZW9OVEw0","email":"xiwei@redhat.com"},"registry.redhat.io":{"auth":"Nzk4NTAzOHx1aGUdxeFc3RzdTQllQUWxsWXUxRGowOUNvQ0FCOmV5SmhiR2NpT2lKU1V6VXhNaUo5LmV5SnpkV0lpT2lJMllXSmpPR0ZpTXpRMU9EYzBOamN3WVRVd1pqWm1NamxrT0dKallqa3dZaUo5LlBONFdTRkdRLTZ1Q1lER2ZJM3RLR3ZyYnlHU1dqVGppZVhDRC1vbjhpMXUxN29YeG9tS09yd20xbjlLbXlvZk80b1pfaEoydnlmZ2VySTdaLVpBSDJiRU5janlWV3h5aEcyQVowRzJLa0VtZk1QT1hQRlVXRjZQSTJaWWd2RXdlT0k2ZzgxR0Nvbm9wLUdZSkVJaXlGenkxVms3d0tMbURfSGVmV1c1X05oTzlBNEY3MUpid3JTeTNRa3V3cUp3cjhIRWlmdUdyOHJKdGZRb2ZFdElYVUVsMm0wSkZoaGV6WFFJeHI5aFlXNXhnMnFpV19VSFY0VjZvRkZjUVF2VDg2SXVIeWNBV1BEVUlKdzdjNnZDdk0wa1E5T2NNZEtBc1NIZ3JRMUdVTTU0NW5SeXBZSFVXMTN0Mk11bWRNYnhmc1FQTEFEa3RfdFI4UThOTk1QWml0YURMT3pqQTV0aVhua0IzUFlfUDBicTUtRnhrNnFUYTBemJaSldsek9fZkVlanBZaHZ0dWktUnp4QUFZSnpILTFlNGExNTlJSGdWdG9lZkZCMzdldW9MYjZNcWs1RmJWX1FKZ0RzYnc3UVA3WEJVX1I2blRPcUV4M0lnQ1RVSGVmdGRQakFJQzdPWGs5U0dzTko0NkhkOUpDRDFmb1Y2TlpVQ0hJcUFWQm1IeU16YzhpMUJ1RmRsZFFfakFGVPZXBrM3ZpWVItaEdUQU82N2Y5X29wa1Zia3V6bXRoVnNwMlczTzF6ZUZ0UVh3a3FRMThFdHlQcHhzSWRyV5bTRhcEVRdFJYZFlQZ0czVmJBR0E4NTdGak90OUx0c3B6dlphNFBCV1lxSHVDLUNzcS1JTHQ5bm92Y3NVEw0","email":"xiwei@redhat.com"},"utilityvm.example.com:5000":{"auth":"b3nNZ0OnJlZGhhdA=="}}}



[xiwei-redhat.com@bastion openstack-upi]$  openshift-install create install-config --dir $HOME/openstack-upi
? SSH Public Key /home/xiwei-redhat.com/.ssh/a389key.pub
? Platform openstack
INFO Credentials loaded from file "/home/xiwei-redhat.com/.config/openstack/clouds.yaml"
? Cloud a389-project
? ExternalNetwork external
? APIFloatingIPAddress 52.116.95.177
? FlavorName 4c16g30d
? Base Domain blue.osp.opentlc.com
? Cluster Name cluster-a389
? Pull Secret [? for help] **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************

[xiwei-redhat.com@bastion openstack-upi]$ pwd
/home/xiwei-redhat.com/openstack-upi

[xiwei-redhat.com@bastion openstack-upi]$ cat install-config.yaml
apiVersion: v1
baseDomain: blue.osp.opentlc.com
compute:
- architecture: amd64
  hyperthreading: Enabled
  name: worker
  platform: {}
  replicas: 0 
controlPlane:
  architecture: amd64
  hyperthreading: Enabled
  name: master
  platform:
    openstack:
      type: 4c16g30d 
  replicas: 3
metadata:
  creationTimestamp: null
  name: "cluster-16f4" 
networking:
  clusterNetwork:
  - cidr: 10.128.0.0/14
    hostPrefix: 23
  machineNetwork:
  - cidr: 192.168.47.0/24 
  networkType: OpenShiftSDN
  serviceNetwork:
  - 172.30.0.0/16
platform:
  openstack:
    apiVIP: 192.168.47.5 
    cloud: "16f4-project"
    computeFlavor: 4c16g30d 
    externalDNS: null
    externalNetwork: external
    ingressVIP: 192.168.47.7 
    lbFloatingIP: 52.116.95.60 
    octaviaSupport: "1"
    region: ""
    trunkSupport: "0" 
publish: External
pullSecret: '<your json merged pull secret>' 
sshKey: |
  ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDRno7MhdEiuxrOTj9Du/8KDT4+KoILI+GdMvjCtzs5rmbOI342YgNc9ojsb6F+vaIMzlbFkf15soEarmgj2BiGaK/6hoI4OVxMOmlJzckEbEUEHpNjiYq0Ih0pylDmMG3BidMuokR6HjcYYTG0ex1jYqOmr7rUZ+e7nLeiniLv2QpcYFHdFDzxEOWYEy6BSAF8dWuJIYfEpDhvOCqCcMqGeWkSpClueEV1KZR+Md3UF+ijqihBXHuZnlbiPVoZZ/G+leWZPjU+IHxHNtJuaGrtIXofQ8M9MSeYA+hhHZBL6ag5pD6gStz3ojQjGwXbbMvhWYFBLjutlWZYSApIgj6T opentlc-mgr@admin.na.shared.opentlc.com
imageContentSources: 
- mirrors:
  - utilityvm.example.com:5000/ocp4/openshift4
  source: quay.io/openshift-release-dev/ocp-release
- mirrors:
  - utilityvm.example.com:5000/ocp4/openshift4
  source: quay.io/openshift-release-dev/ocp-v4.0-art-dev
additionalTrustBundle: |
  -----BEGIN CERTIFICATE-----
  MIIF5zCCA8+gAwIBAgIJAKQGgnmWgGkuMA0GCSqGSIb3DQEBCwUAMIGJMQswCQYD
  VQQGEwJVUzENMAsGA1UECAwEdGVtcDENMAsGA1UEBwwEdGVtcDENMAsGA1UECgwE
  dGVtcDENMAsGA1UECwwEdGVtcDEeMBwGA1UEAwwVdXRpbGl0eXZtLmV4YW1wbGUu
  Y29tMR4wHAYJKoZIhvcNAQkBFg9qdWRkQHJlZGh0YS5jb20wHhcNMjAwNzIzMTgy
  MTM0WhcNMjEwNzIzMTgyMTM0WjCBiTELMAkGA1UEBhMCVVMxDTALBgNVBAgMBHRl
  bXAxDTALBgNVBAcMBHRlbXAxDTALBgNVBAoMBHRlbXAxDTALBgNVBAsMBHRlbXAx
  HjAcBgNVBAMMFXV0aWxpdHl2bS5leGFtcGxlLmNvbTEeMBwGCSqGSIb3DQEJARYP
  anVkZEByZWRodGEuY29tMIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEA
  ulXc9JIkoGwXhjeNpUp9aHhtNOPWaHcAfU1+82BlHZkNKQo6/q9WYu9hMxUUfFDh
  9cwtTC6d9l+WMXf+vCLISBGHh4hEZvdP46XWyfMiTDliQY6W4mvK4NxcDIo6FFOF
  yMu0o6KagpPtU1Xjdx9iQ/w4GJcCLzL8TDjtfbYsrHWOJOMw6FPbkbqLj6dNnvG6
  ipapRQ4W4Kknb4Oc3OsftNDEQaqQGtFx2PDu6IuKwyzc0H/aENh7YJ/gg7MMESwf
  Z82mD0foPwk9/NdC+I9jDt1z/lGA6SMvtdAu4gFxmgHp+MdclGyaWgYEVec1mWMZ
  WbNheCD0A2Kg7cNvYbRCzsnqpxAtx8D0UfPu7piVDECtTZ5YGoQiAiNn2DFd9o3O
  YOuykBe4EfLDlHdKdHK4RJOw+pxVpg7Bgkfs0ptaJfjzJmAunL50mSrfGCnaw7Yy
  UZ581B6jeUSeW6jez6F6w5hr0WCI59OpPoS1Go+pE2+FXr0hk54DtikjzAJjFgpx
  kI7kOlQEZlp1+dENBzks+Th66VT0YSrtX0PKW5F8rO7ORfDlLUgOv5GaFoxQxSIz
  3qR0b7YIaThwaMr2mPSBoTabTWuitzZLx7HCQ2pZ5k3VMIMZN8PlxhjedaF5VKHK
  uVmwaLHm56w5LtDLfjTvMErWyOFxLm9uRX98/BvzVKsCAwEAAaNQME4wHQYDVR0O
  BBYEFGuuitaLdtF3BnwTkIGCy/OTrJlqMB8GA1UdIwQYMBaAFGuuitaLdtF3BnwT
  kIGCy/OTrJlqMAwGA1UdEwQFMAMBAf8wDQYJKoZIhvcNAQELBQADggIBAC07Ijp4
  HjYfwTMvTR6dJybn1Tx+o21DMRUWTpetG8xdrfaI0E9n8gpg68NJInwj9308YLUw
  av3oK7wRmuwrYt+2d0ei5tZLvof0vZOa1S9PuqYgOdTdt0fISlDXu9rv+AmB7bSe
  pMQZ0lvtUQcOfEZRwgBLeaQ45SI/aSO2ugtkA9ZO2AAYOGCRAE2hZ3AqeE3SGCRy
  QQ7ftQcs4yu4iYLqpeKkfo+3wmovK/cFtQRAtck5KT3eEG1dHkFzXkWaunRYFACk
  ZjpsyvDLNP7trjqyFL72I63vP2M4nXNm9OFjEk9N0fyJiFhIxPqarKoqkwX3DV4V
  YuBxbCUhP2arQo9mfPiMLNysItmx4ajXjRWJeTahxiSq79fHd/ec6xo7zjmIXD0t
  zMURu5nYH9LfwUKU7WdDHbupAipDxkqb+vzuCuSMJDJ5V//4jTpXQuC/TXBSDz50
  28D54nkveANNveKDhdpFpEqOVgbP/1dlOKDF5/up4BerEWBUn7FhenttTBMQTqiO
  a6RqpmkkfO0axQ6UCSzURkz11NqF8QOcBRxBDwlF10x9ZseXpvRajPA+2HEcEA5K
  ExNLs9ZVl1YnIW9MTxwjVx4s87bORkKHtfEhA2PDDtWWEXjxt7vdZN3mljtzDYlH
  1CvEPwrxJxpUwDcKaajWjt6mgk2CSLRJbS3n
  -----END CERTIFICATE-----



[xiwei-redhat.com@bastion openstack-upi]$ mkdir -p $HOME/backup
[xiwei-redhat.com@bastion openstack-upi]$ cp $HOME/openstack-upi/install-config.yaml $HOME/backup/
[xiwei-redhat.com@bastion openstack-upi]$ openshift-install create manifests --dir $HOME/openstack-upi
INFO Credentials loaded from file "/home/xiwei-redhat.com/.config/openstack/clouds.yaml"
INFO Consuming Install Config from target directory
[xiwei-redhat.com@bastion openstack-upi]$ tree
.
├── manifests
│   ├── 04-openshift-machine-config-operator.yaml
│   ├── cloud-provider-config.yaml
│   ├── cluster-config.yaml
│   ├── cluster-dns-02-config.yml
│   ├── cluster-infrastructure-02-config.yml
│   ├── cluster-ingress-02-config.yml
│   ├── cluster-network-01-crd.yml
│   ├── cluster-network-02-config.yml
│   ├── cluster-proxy-01-config.yaml
│   ├── cluster-scheduler-02-config.yml
│   ├── cvo-overrides.yaml
│   ├── etcd-ca-bundle-configmap.yaml
│   ├── etcd-client-secret.yaml
│   ├── etcd-host-service-endpoints.yaml
│   ├── etcd-host-service.yaml
│   ├── etcd-metric-client-secret.yaml
│   ├── etcd-metric-serving-ca-configmap.yaml
│   ├── etcd-metric-signer-secret.yaml
│   ├── etcd-namespace.yaml
│   ├── etcd-service.yaml
│   ├── etcd-serving-ca-configmap.yaml
│   ├── etcd-signer-secret.yaml
│   ├── kube-cloud-config.yaml
│   ├── kube-system-configmap-root-ca.yaml
│   ├── machine-config-server-tls-secret.yaml
│   ├── openshift-config-secret-pull-secret.yaml
│   └── user-ca-bundle-config.yaml
└── openshift
    ├── 99_cloud-creds-secret.yaml
    ├── 99_kubeadmin-password-secret.yaml
    ├── 99_openshift-cluster-api_master-machines-0.yaml
    ├── 99_openshift-cluster-api_master-machines-1.yaml
    ├── 99_openshift-cluster-api_master-machines-2.yaml
    ├── 99_openshift-cluster-api_master-user-data-secret.yaml
    ├── 99_openshift-cluster-api_worker-machineset-0.yaml
    ├── 99_openshift-cluster-api_worker-user-data-secret.yaml
    ├── 99_openshift-machineconfig_99-master-ssh.yaml
    ├── 99_openshift-machineconfig_99-worker-ssh.yaml
    ├── 99_role-cloud-creds-secret-reader.yaml
    └── openshift-install-manifests.yaml

2 directories, 39 files
[xiwei-redhat.com@bastion openstack-upi]$  ansible localhost -m lineinfile -a 'path="$HOME/openstack-upi/manifests/cluster-scheduler-02-config.yml" regexp="^  mastersSchedulable" line="  mastersSchedulable: false"'
localhost | SUCCESS => {
    "backup": "",
    "changed": false,
    "msg": ""
}
[xiwei-redhat.com@bastion openstack-upi]$ cat $HOME/openstack-upi/manifests/cluster-scheduler-02-config.yml
apiVersion: config.openshift.io/v1
kind: Scheduler
metadata:
  creationTimestamp: null
  name: cluster
spec:
  mastersSchedulable: false
  policy:
    name: ""
status: {}
[xiwei-redhat.com@bastion openstack-upi]$  rm -f openshift/99_openshift-cluster-api_master-machines-*.yaml
[xiwei-redhat.com@bastion openstack-upi]$  openshift-install create ignition-configs --dir $HOME/openstack-upi
INFO Consuming Common Manifests from target directory
INFO Consuming Worker Machines from target directory
INFO Consuming Openshift Manifests from target directory
INFO Consuming OpenShift Install (Manifests) from target directory
INFO Consuming Master Machines from target directory
[xiwei-redhat.com@bastion openstack-upi]$ tree
.
├── auth
│   ├── kubeadmin-password
│   └── kubeconfig
├── bootstrap.ign
├── master.ign
├── metadata.json
└── worker.ign

1 directory, 6 files


创建一个将主机名设置为OpenStack实例名称的文件。

将dhcp-client配置添加到NetworkManager。

添加dhclient配置。
[xiwei-redhat.com@bastion openstack-upi]$  ansible localhost -m lineinfile -a 'path=$HOME/.bashrc regexp="^export INFRA_ID" line="export INFRA_ID=$(jq -r .infraID $HOME/openstack-upi/metadata.json)"'
localhost | CHANGED => {
    "backup": "",
    "changed": true,
    "msg": "line added"
}

修改后，该文件增加了最后一行：
[xiwei-redhat.com@bastion ~]$ cat $HOME/.bashrc
# .bashrc

# Source global definitions
if [ -f /etc/bashrc ]; then
        . /etc/bashrc
fi

# Uncomment the following line if you don't like systemctl's auto-paging feature:
# export SYSTEMD_PAGER=

# User specific aliases and functions
export GUID=3123
export CLOUDUSER=cloud-user
export API_FIP=52.116.95.215
export INGRESS_FIP=52.116.95.185
export OPENSHIFT_DNS_ZONE=blue.osp.opentlc.com
export OS_CLOUD=3123-project
export OCP_RELEASE=4.5.12
export INFRA_ID=$(jq -r .infraID $HOME/openstack-upi/metadata.json)

[xiwei-redhat.com@bastion openstack-upi]$ source $HOME/.bashrc
[xiwei-redhat.com@bastion openstack-upi]$ echo $INFRA_ID
cluster-a389-287mt
[xiwei-redhat.com@bastion openstack-upi]$ cd $HOME/openstack-upi
[xiwei-redhat.com@bastion openstack-upi]$  python3 $HOME/resources/update_ignition.py
[xiwei-redhat.com@bastion openstack-upi]$

要查看附加到bootstrap.ign文件中的值，可以运行以下命令。
[xiwei-redhat.com@bastion openstack-upi]$  jq '.storage.files | map(select(.path=="/etc/dhcp/dhclient.conf", .path=="/etc/NetworkManager/conf.d/dhcp-client.conf", .path=="/etc/dhcp/dhclient.conf", .path=="/etc/hostname"))' bootstrap.ign
[
  {
    "filesystem": "root",
    "path": "/etc/NetworkManager/conf.d/dhcp-client.conf",
    "user": {
      "name": "root"
    },
    "contents": {
      "source": "data:text/plain;charset=utf-8;base64,W21haW5dCmRoY3A9ZGhjbGllbnQK",
      "verification": {}
    },
    "mode": 384
  },
  {
    "filesystem": "root",
    "path": "/etc/dhcp/dhclient.conf",
    "user": {
      "name": "root"
    },
    "contents": {
      "source": "data:text/plain;charset=utf-8;base64,c2VuZCBkaGNwLWNsaWVudC1pZGVudGlmaWVyID0gaGFyZHdhcmU7CnByZXBlbmQgZG9tYWluLW5hbWUtc2VydmVycyAxMjcuMC4wLjE7Cg==",
      "verification": {}
    },
    "mode": 384
  },
  {
    "filesystem": "root",
    "path": "/etc/dhcp/dhclient.conf",
    "user": {
      "name": "root"
    },
    "contents": {
      "source": "data:text/plain;charset=utf-8;base64,c2VuZCBkaGNwLWNsaWVudC1pZGVudGlmaWVyID0gaGFyZHdhcmU7CnByZXBlbmQgZG9tYWluLW5hbWUtc2VydmVycyAxMjcuMC4wLjE7Cg==",
      "verification": {}
    },
    "mode": 384
  },
  {
    "path": "/etc/hostname",
    "mode": 420,
    "contents": {
      "source": "data:text/plain;charset=utf-8;base64,Y2x1c3Rlci1hMzg5LTI4N210LWJvb3RzdHJhcAo=",
      "verification": {}
    },
    "filesystem": "root"
  },
  {
    "path": "/etc/NetworkManager/conf.d/dhcp-client.conf",
    "mode": 420,
    "contents": {
      "source": "data:text/plain;charset=utf-8;base64,W21haW5dCmRoY3A9ZGhjbGllbnQK",
      "verification": {}
    },
    "filesystem": "root"
  },
  {
    "path": "/etc/dhcp/dhclient.conf",
    "mode": 420,
    "contents": {
      "source": "data:text/plain;charset=utf-8;base64,c2VuZCBkaGNwLWNsaWVudC1pZGVudGlmaWVyID0gaGFyZHdhcmU7CnByZXBlbmQgZG9tYWluLW5hbWUtc2VydmVycyAxMjcuMC4wLjE7Cg==",
      "verification": {}
    },
    "filesystem": "root"
  },
  {
    "path": "/etc/dhcp/dhclient.conf",
    "mode": 420,
    "contents": {
      "source": "data:text/plain;charset=utf-8;base64,c2VuZCBkaGNwLWNsaWVudC1pZGVudGlmaWVyID0gaGFyZHdhcmU7CnByZXBlbmQgZG9tYWluLW5hbWUtc2VydmVycyAxMjcuMC4wLjE7Cg==",
      "verification": {}
    },
    "filesystem": "root"
  }
]
最后，对于点火更改，必须为将要创建的三个主节点创建点火文件。运行以下命令来创建这些文件。
[xiwei-redhat.com@bastion openstack-upi]$ 
for index in $(seq 0 2); do
MASTER_HOSTNAME="$INFRA_ID-master-$index\n"
python3 -c "import base64, json, sys;
ignition = json.load(sys.stdin);
files = ignition['storage'].get('files', []);
files.append({'path': '/etc/hostname', 'mode': 420, 'contents': {'source': 'data:text/plain;charset=utf-8;base64,' + base64.standard_b64encode(b'$MASTER_HOSTNAME').decode().strip(), 'verification': {}}, 'filesystem': 'root'});
ignition['storage']['files'] = files;
json.dump(ignition, sys.stdout)" <master.ign >"$INFRA_ID-master-$index-ignition.json"
done


从您的堡垒，将bootstrap.ign文件复制到UtilityVM。将其复制到正确的位置并设置SELinux上下文，以便可以对其进行访问。
[xiwei-redhat.com@bastion openstack-upi]$ scp bootstrap.ign utilityvm.example.com:
bootstrap.ign                                                                        100%  308KB  43.9MB/s   00:00
[xiwei-redhat.com@bastion openstack-upi]$  ssh utilityvm.example.com chmod 644 bootstrap.ign
[xiwei-redhat.com@bastion openstack-upi]$  ssh utilityvm.example.com sudo mv bootstrap.ign /var/www/html/
[xiwei-redhat.com@bastion openstack-upi]$ ssh utilityvm.example.com sudo restorecon /var/www/html/bootstrap.ign



确保可以下载
[xiwei-redhat.com@bastion openstack-upi]$ wget -O $HOME/mybootstrap.ign http://utilityvm.example.com/bootstrap.ign
--2020-07-27 05:16:33--  http://utilityvm.example.com/bootstrap.ign
Resolving utilityvm.example.com (utilityvm.example.com)... 192.168.47.18
Connecting to utilityvm.example.com (utilityvm.example.com)|192.168.47.18|:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 315557 (308K)
Saving to: ‘/home/xiwei-redhat.com/mybootstrap.ign’

100%[=============================================================================>] 315,557     --.-K/s   in 0.01s

2020-07-27 05:16:33 (30.6 MB/s) - ‘/home/xiwei-redhat.com/mybootstrap.ign’ saved [315557/315557]

您现在唯一需要的是引导节点的新点火文件，它将指向真实的点火文件。这称为自举点火垫片。该命令将为您生成文件，指向您从实用程序VM托管的真正的bootstrap.ign。这个新文件是启动时将提供给引导节点的点火文件。
[xiwei-redhat.com@bastion openstack-upi]$  
cat << EOF > $HOME/openstack-upi/$INFRA_ID-bootstrap-ignition.json
 {
   "ignition": {
     "config": {
       "append": [
         {
           "source": "http://bastion.example.com/bootstrap.ign",
           "verification": {}
         }
       ]
     },
     "security": {},
     "timeouts": {},
     "version": "2.4.0"
   },
   "networkd": {},
   "passwd": {},
   "storage": {},
   "systemd": {}
 }
 EOF


创建Bootstrap Node
[xiwei-redhat.com@bastion openstack-upi]$ openstack port create --network "$GUID-ocp-network" --security-group "$GUID-master_sg" --fixed-ip "subnet=$GUID-ocp-subnet,ip-address=192.168.47.5" --tag openshiftClusterID="$INFRA_ID" "$INFRA_ID-api-port" -f json
 openstack port create \
  --network "$GUID-ocp-network" \
  --security-group "$GUID-worker_sg" \
  --fixed-ip "subnet=$GUID-ocp-subnet,ip-address=192.168.47.7" \
  --tag openshiftClusterID="$INFRA_ID" \
  "$INFRA_ID-ingress-port"{
  "admin_state_up": true,
  "allowed_address_pairs": [],
  "binding_host_id": null,
  "binding_profile": null,
  "binding_vif_details": null,
  "binding_vif_type": null,
  "binding_vnic_type": "normal",
  "created_at": "2020-07-27T09:17:55Z",
  "data_plane_status": null,
  "description": "",
  "device_id": "",
  "device_owner": "",
  "dns_assignment": [
    {
      "hostname": "host-192-168-47-5",
      "ip_address": "192.168.47.5",
      "fqdn": "host-192-168-47-5.example.com."
    }
  ],
  "dns_domain": "",
  "dns_name": "",
  "extra_dhcp_opts": [],
  "fixed_ips": [
    {
      "subnet_id": "5956d52b-7612-4f5b-9d7b-7924843ea42c",
      "ip_address": "192.168.47.5"
    }
  ],
  "id": "993b1656-4572-4ed1-b393-f6158c997b12",
  "location": {
    "cloud": "a389-project",
    "region_name": "regionOne",
    "zone": null,
    "project": {
      "id": "4541cf7e0bf4484b907d0024eb60b327",
      "name": "a389-project",
      "domain_id": "default",
      "domain_name": null
    }
  },
  "mac_address": "fa:16:3e:a6:c4:f4",
  "name": "cluster-a389-287mt-api-port",
  "network_id": "261b4a11-55ac-413b-adb5-357fea543c1a",
  "port_security_enabled": true,
  "project_id": "4541cf7e0bf4484b907d0024eb60b327",
  "propagate_uplink_status": null,
  "qos_policy_id": null,
  "resource_request": null,
  "revision_number": 6,
  "security_group_ids": [
    "8e6a67a8-75c9-4068-b8f1-82fbecfbf01e"
  ],
  "status": "DOWN",
  "tags": [
    "openshiftClusterID=cluster-a389-287mt"
  ],
  "trunk_details": null,
  "updated_at": "2020-07-27T09:17:55Z"
}
[xiwei-redhat.com@bastion openstack-upi]$  
openstack port create \
   --network "$GUID-ocp-network" \
   --security-group "$GUID-worker_sg" \
   --fixed-ip "subnet=$GUID-ocp-subnet,ip-address=192.168.47.7" \
   --tag openshiftClusterID="$INFRA_ID" \
   "$INFRA_ID-ingress-port"

$ openstack floating ip set --port "$INFRA_ID-api-port" $API_FIP
$ openstack floating ip set --port "$INFRA_ID-ingress-port" $INGRESS_FIP

[xiwei-redhat.com@bastion openstack-upi]$  openstack floating ip list -c ID -c "Floating IP Address" -c "Fixed IP Address"
+--------------------------------------+---------------------+------------------+
| ID                                   | Floating IP Address | Fixed IP Address |
+--------------------------------------+---------------------+------------------+
| 8c3a0b64-2fbe-462e-a113-324933bdd664 | 52.116.95.208       | 192.168.47.40    |
| 9058a20f-366c-4e4b-b471-e9d9542bc04a | 52.116.95.199       | 192.168.47.7     |
| da624837-77c7-4b69-bdbd-3a6273996a1e | 52.116.95.177       | 192.168.47.5     |
+--------------------------------------+---------------------+------------------+

+--------------------------------------+---------------------+------------------+

 openstack port create \
  --network "$GUID-ocp-network" \
  --security-group "$GUID-master_sg" \
  --allowed-address ip-address=192.168.47.5 \
  --allowed-address ip-address=192.168.47.6 \
  --allowed-address ip-address=192.168.47.7 \
  --tag openshiftClusterID="$INFRA_ID" \
  "$INFRA_ID-bootstrap-port"

查看镜像：
[xiwei-redhat.com@bastion openstack-upi]$ openstack  image list |grep -i ocp45
| e1a13377-2b55-4aee-ba05-0391a53c92e8 | rhcos-ocp45                                                   | active |
[xiwei-redhat.com@bastion openstack-upi]$


[xiwei-redhat.com@bastion openstack-upi]$ openstack server create --image rhcos-ocp45 --flavor 4c16g30d --user-data "$HOME/openstack-upi/$INFRA_ID-bootstrap-ignition.json" --port "$INFRA_ID-bootstrap-port" --wait --property openshiftClusterID="$INFRA_ID" "$INFRA_ID-bootstrap"
+-----------------------------+----------------------------------------------------------+
| Field                       | Value                                                    |
+-----------------------------+----------------------------------------------------------+
| OS-DCF:diskConfig           | MANUAL                                                   |
| OS-EXT-AZ:availability_zone | nova                                                     |
| OS-EXT-STS:power_state      | Running                                                  |
| OS-EXT-STS:task_state       | None                                                     |
| OS-EXT-STS:vm_state         | active                                                   |
| OS-SRV-USG:launched_at      | 2020-07-27T09:35:10.000000                               |
| OS-SRV-USG:terminated_at    | None                                                     |
| accessIPv4                  |                                                          |
| accessIPv6                  |                                                          |
| addresses                   | a389-ocp-network=192.168.47.16                           |
| adminPass                   | cuJk7kkMziYd                                             |
| config_drive                |                                                          |
| created                     | 2020-07-27T09:34:36Z                                     |
| flavor                      | 4c16g30d (a02c754b-dbc9-4db1-afb7-6abb90071f41)          |
| hostId                      | 3177ec387da55f6a28b3451e4381bb0c5923df7cc4c066c8e9893b2f |
| id                          | 8f0151f5-9a96-465a-9eb1-899f4f08200c                     |
| image                       | rhcos-ocp45 (e1a13377-2b55-4aee-ba05-0391a53c92e8)       |
| key_name                    | None                                                     |
| name                        | cluster-a389-287mt-bootstrap                             |
| progress                    | 0                                                        |
| project_id                  | 4541cf7e0bf4484b907d0024eb60b327                         |
| properties                  | openshiftClusterID='cluster-a389-287mt'                  |
| security_groups             | name='a389-master_sg'                                    |
| status                      | ACTIVE                                                   |
| updated                     | 2020-07-27T09:35:10Z                                     |
| user_id                     | 964aa0854e564db6919c0fc1e14e4dc2                         |
| volumes_attached            |                                                          |
+-----------------------------+----------------------------------------------------------+


通过命令行查看vm启动状态：
openstack console log show "$INFRA_ID-bootstrap"

Red Hat Enterprise Linux CoreOS 45.82.202007141718-0 (Ootpa) 4.5
SSH host key: SHA256:2d2eaNZz9tSavhiad9q79iFJnIgL5P44dCg7MnaNORg (ECDSA)
SSH host key: SHA256:QOGVpb1n6X3EJhH+sd/tw2jq0Pd1ENVnrqXz1SoQDnw (ED25519)
SSH host key: SHA256:o5QMKfuStC40UrK3Slz/FF371rlStX8VBkko4Tx5ecw (RSA)
ens3: 192.168.47.16 fe80::d3:be58:d145:a289
cluster-a389-287mt-bootstrap login:


登录bootstrap，查看日志：
ssh -i $HOME/.ssh/${GUID}key.pem core@$INFRA_ID-bootstrap.example.com
$ journalctl -b -f -u release-image.service -u bootkube.service

=================================================================================
 Create Masters创建master


创建主机所需的网络端口。此命令将为您创建3个端口-每个主端口一个。记下这些端口的创建位置。
[xiwei-redhat.com@bastion ~]$  openstack server list -f json
[
  {
    "ID": "8f0151f5-9a96-465a-9eb1-899f4f08200c",
    "Name": "cluster-a389-287mt-bootstrap",
    "Status": "ACTIVE",
    "Networks": "a389-ocp-network=192.168.47.16",
    "Image": "rhcos-ocp45",
    "Flavor": "4c16g30d"
  },
  {
    "ID": "06646a75-b6ca-48c2-b5ed-891c2f449c11",
    "Name": "utilityvm",
    "Status": "ACTIVE",
    "Networks": "a389-ocp-network=192.168.47.18",
    "Image": "",
    "Flavor": "2c2g30d"
  },
  {
    "ID": "21004553-9b98-4e8f-9aef-d721abdb7ed9",
    "Name": "bastion",
    "Status": "ACTIVE",
    "Networks": "a389-ocp-network=192.168.47.40, 52.116.95.208",
    "Image": "",
    "Flavor": "2c2g30d"
  }
]
[xiwei-redhat.com@bastion ~]$ 
for index in $(seq 0 2); do
     openstack port create \
     --network "$GUID-ocp-network" \
     --security-group "$GUID-master_sg" \
     --allowed-address ip-address=192.168.47.5 \
     --allowed-address ip-address=192.168.47.6 \
     --allowed-address ip-address=192.168.47.7 \
     --tag openshiftClusterID="$INFRA_ID" \
     "$INFRA_ID-master-port-$index"
 done
+-------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Field                   | Value                                                                                                                                                                               |
+-------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| admin_state_up          | UP                                                                                                                                                                                  |
| allowed_address_pairs   | ip_address='192.168.47.5', mac_address='fa:16:3e:df:92:bc'                                                                                                                          |
|                         | ip_address='192.168.47.6', mac_address='fa:16:3e:df:92:bc'                                                                                                                          |
|                         | ip_address='192.168.47.7', mac_address='fa:16:3e:df:92:bc'                                                                                                                          |
| binding_host_id         | None                                                                                                                                                                                |
| binding_profile         | None                                                                                                                                                                                |
| binding_vif_details     | None                                                                                                                                                                                |
| binding_vif_type        | None                                                                                                                                                                                |
| binding_vnic_type       | normal                                                                                                                                                                              |
| created_at              | 2020-07-27T09:38:03Z                                                                                                                                                                |
| data_plane_status       | None                                                                                                                                                                                |
| description             |                                                                                                                                                                                     |
| device_id               |                                                                                                                                                                                     |
| device_owner            |                                                                                                                                                                                     |
| dns_assignment          | fqdn='host-192-168-47-23.example.com.', hostname='host-192-168-47-23', ip_address='192.168.47.23'                                                                                   |
| dns_domain              |                                                                                                                                                                                     |
| dns_name                |                                                                                                                                                                                     |
| extra_dhcp_opts         |                                                                                                                                                                                     |
| fixed_ips               | ip_address='192.168.47.23', subnet_id='5956d52b-7612-4f5b-9d7b-7924843ea42c'                                                                                                        |
| id                      | 67b83e94-2886-412a-9a89-40b84ace7277                                                                                                                                                |
| location                | cloud='a389-project', project.domain_id='default', project.domain_name=, project.id='4541cf7e0bf4484b907d0024eb60b327', project.name='a389-project', region_name='regionOne', zone= |
| mac_address             | fa:16:3e:df:92:bc                                                                                                                                                                   |
| name                    | cluster-a389-287mt-master-port-0                                                                                                                                                    |
| network_id              | 261b4a11-55ac-413b-adb5-357fea543c1a                                                                                                                                                |
| port_security_enabled   | True                                                                                                                                                                                |
| project_id              | 4541cf7e0bf4484b907d0024eb60b327                                                                                                                                                    |
| propagate_uplink_status | None                                                                                                                                                                                |
| qos_policy_id           | None                                                                                                                                                                                |
| resource_request        | None                                                                                                                                                                                |
| revision_number         | 8                                                                                                                                                                                   |
| security_group_ids      | 8e6a67a8-75c9-4068-b8f1-82fbecfbf01e                                                                                                                                                |
| status                  | DOWN                                                                                                                                                                                |
| tags                    | openshiftClusterID=cluster-a389-287mt                                                                                                                                               |
| trunk_details           | None                                                                                                                                                                                |
| updated_at              | 2020-07-27T09:38:03Z                                                                                                                                                                |
+-------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
+-------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Field                   | Value                                                                                                                                                                               |
+-------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| admin_state_up          | UP                                                                                                                                                                                  |
| allowed_address_pairs   | ip_address='192.168.47.5', mac_address='fa:16:3e:8a:a8:a3'                                                                                                                          |
|                         | ip_address='192.168.47.6', mac_address='fa:16:3e:8a:a8:a3'                                                                                                                          |
|                         | ip_address='192.168.47.7', mac_address='fa:16:3e:8a:a8:a3'                                                                                                                          |
| binding_host_id         | None                                                                                                                                                                                |
| binding_profile         | None                                                                                                                                                                                |
| binding_vif_details     | None                                                                                                                                                                                |
| binding_vif_type        | None                                                                                                                                                                                |
| binding_vnic_type       | normal                                                                                                                                                                              |
| created_at              | 2020-07-27T09:38:09Z                                                                                                                                                                |
| data_plane_status       | None                                                                                                                                                                                |
| description             |                                                                                                                                                                                     |
| device_id               |                                                                                                                                                                                     |
| device_owner            |                                                                                                                                                                                     |
| dns_assignment          | fqdn='host-192-168-47-14.example.com.', hostname='host-192-168-47-14', ip_address='192.168.47.14'                                                                                   |
| dns_domain              |                                                                                                                                                                                     |
| dns_name                |                                                                                                                                                                                     |
| extra_dhcp_opts         |                                                                                                                                                                                     |
| fixed_ips               | ip_address='192.168.47.14', subnet_id='5956d52b-7612-4f5b-9d7b-7924843ea42c'                                                                                                        |
| id                      | 8527f301-715c-4caa-aa48-d212e66c3246                                                                                                                                                |
| location                | cloud='a389-project', project.domain_id='default', project.domain_name=, project.id='4541cf7e0bf4484b907d0024eb60b327', project.name='a389-project', region_name='regionOne', zone= |
| mac_address             | fa:16:3e:8a:a8:a3                                                                                                                                                                   |
| name                    | cluster-a389-287mt-master-port-1                                                                                                                                                    |
| network_id              | 261b4a11-55ac-413b-adb5-357fea543c1a                                                                                                                                                |
| port_security_enabled   | True                                                                                                                                                                                |
| project_id              | 4541cf7e0bf4484b907d0024eb60b327                                                                                                                                                    |
| propagate_uplink_status | None                                                                                                                                                                                |
| qos_policy_id           | None                                                                                                                                                                                |
| resource_request        | None                                                                                                                                                                                |
| revision_number         | 8                                                                                                                                                                                   |
| security_group_ids      | 8e6a67a8-75c9-4068-b8f1-82fbecfbf01e                                                                                                                                                |
| status                  | DOWN                                                                                                                                                                                |
| tags                    | openshiftClusterID=cluster-a389-287mt                                                                                                                                               |
| trunk_details           | None                                                                                                                                                                                |
| updated_at              | 2020-07-27T09:38:09Z                                                                                                                                                                |
+-------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
+-------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Field                   | Value                                                                                                                                                                               |
+-------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| admin_state_up          | UP                                                                                                                                                                                  |
| allowed_address_pairs   | ip_address='192.168.47.5', mac_address='fa:16:3e:40:61:33'                                                                                                                          |
|                         | ip_address='192.168.47.6', mac_address='fa:16:3e:40:61:33'                                                                                                                          |
|                         | ip_address='192.168.47.7', mac_address='fa:16:3e:40:61:33'                                                                                                                          |
| binding_host_id         | None                                                                                                                                                                                |
| binding_profile         | None                                                                                                                                                                                |
| binding_vif_details     | None                                                                                                                                                                                |
| binding_vif_type        | None                                                                                                                                                                                |
| binding_vnic_type       | normal                                                                                                                                                                              |
| created_at              | 2020-07-27T09:38:15Z                                                                                                                                                                |
| data_plane_status       | None                                                                                                                                                                                |
| description             |                                                                                                                                                                                     |
| device_id               |                                                                                                                                                                                     |
| device_owner            |                                                                                                                                                                                     |
| dns_assignment          | fqdn='host-192-168-47-21.example.com.', hostname='host-192-168-47-21', ip_address='192.168.47.21'                                                                                   |
| dns_domain              |                                                                                                                                                                                     |
| dns_name                |                                                                                                                                                                                     |
| extra_dhcp_opts         |                                                                                                                                                                                     |
| fixed_ips               | ip_address='192.168.47.21', subnet_id='5956d52b-7612-4f5b-9d7b-7924843ea42c'                                                                                                        |
| id                      | 0e851b3c-7f1e-4ddf-a55d-e79974d5fa19                                                                                                                                                |
| location                | cloud='a389-project', project.domain_id='default', project.domain_name=, project.id='4541cf7e0bf4484b907d0024eb60b327', project.name='a389-project', region_name='regionOne', zone= |
| mac_address             | fa:16:3e:40:61:33                                                                                                                                                                   |
| name                    | cluster-a389-287mt-master-port-2                                                                                                                                                    |
| network_id              | 261b4a11-55ac-413b-adb5-357fea543c1a                                                                                                                                                |
| port_security_enabled   | True                                                                                                                                                                                |
| project_id              | 4541cf7e0bf4484b907d0024eb60b327                                                                                                                                                    |
| propagate_uplink_status | None                                                                                                                                                                                |
| qos_policy_id           | None                                                                                                                                                                                |
| resource_request        | None                                                                                                                                                                                |
| revision_number         | 8                                                                                                                                                                                   |
| security_group_ids      | 8e6a67a8-75c9-4068-b8f1-82fbecfbf01e                                                                                                                                                |
| status                  | DOWN                                                                                                                                                                                |
| tags                    | openshiftClusterID=cluster-a389-287mt                                                                                                                                               |
| trunk_details           | None                                                                                                                                                                                |
| updated_at              | 2020-07-27T09:38:15Z                                                                                                                                                                |
+-------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+


创建网络端口后，您可以继续创建VM。此命令将为您创建3个主节点。请注意正在创建的内容以及它与您在上一步中创建的网络端口之间的关系。
[xiwei-redhat.com@bastion ~]$
 for index in $(seq 0 2); do
     openstack server create \
     --boot-from-volume 30 \
     --image rhcos-ocp45 \
     --flavor 4c16g30d \
     --user-data "$HOME/openstack-upi/$INFRA_ID-master-$index-ignition.json" \
     --port "$INFRA_ID-master-port-$index" \
     --property openshiftClusterID="$INFRA_ID" \
     "$INFRA_ID-master-$index"
 done
+-----------------------------+-------------------------------------------------+
| Field                       | Value                                           |
+-----------------------------+-------------------------------------------------+
| OS-DCF:diskConfig           | MANUAL                                          |
| OS-EXT-AZ:availability_zone |                                                 |
| OS-EXT-STS:power_state      | NOSTATE                                         |
| OS-EXT-STS:task_state       | scheduling                                      |
| OS-EXT-STS:vm_state         | building                                        |
| OS-SRV-USG:launched_at      | None                                            |
| OS-SRV-USG:terminated_at    | None                                            |
| accessIPv4                  |                                                 |
| accessIPv6                  |                                                 |
| addresses                   |                                                 |
| adminPass                   | 4cXEgCnUiDAG                                    |
| config_drive                |                                                 |
| created                     | 2020-07-27T09:39:28Z                            |
| flavor                      | 4c16g30d (a02c754b-dbc9-4db1-afb7-6abb90071f41) |
| hostId                      |                                                 |
| id                          | 1ac58d1c-61d0-4be6-88ae-23cae29fc503            |
| image                       |                                                 |
| key_name                    | None                                            |
| name                        | cluster-a389-287mt-master-0                     |
| progress                    | 0                                               |
| project_id                  | 4541cf7e0bf4484b907d0024eb60b327                |
| properties                  | openshiftClusterID='cluster-a389-287mt'         |
| security_groups             | name='default'                                  |
| status                      | BUILD                                           |
| updated                     | 2020-07-27T09:39:28Z                            |
| user_id                     | 964aa0854e564db6919c0fc1e14e4dc2                |
| volumes_attached            |                                                 |
+-----------------------------+-------------------------------------------------+
+-----------------------------+-------------------------------------------------+
| Field                       | Value                                           |
+-----------------------------+-------------------------------------------------+
| OS-DCF:diskConfig           | MANUAL                                          |
| OS-EXT-AZ:availability_zone |                                                 |
| OS-EXT-STS:power_state      | NOSTATE                                         |
| OS-EXT-STS:task_state       | scheduling                                      |
| OS-EXT-STS:vm_state         | building                                        |
| OS-SRV-USG:launched_at      | None                                            |
| OS-SRV-USG:terminated_at    | None                                            |
| accessIPv4                  |                                                 |
| accessIPv6                  |                                                 |
| addresses                   |                                                 |
| adminPass                   | 3mWfy5vxUBb5                                    |
| config_drive                |                                                 |
| created                     | 2020-07-27T09:39:39Z                            |
| flavor                      | 4c16g30d (a02c754b-dbc9-4db1-afb7-6abb90071f41) |
| hostId                      |                                                 |
| id                          | 218e6982-c7b9-4623-8639-15f764d8744b            |
| image                       |                                                 |
| key_name                    | None                                            |
| name                        | cluster-a389-287mt-master-1                     |
| progress                    | 0                                               |
| project_id                  | 4541cf7e0bf4484b907d0024eb60b327                |
| properties                  | openshiftClusterID='cluster-a389-287mt'         |
| security_groups             | name='default'                                  |
| status                      | BUILD                                           |
| updated                     | 2020-07-27T09:39:39Z                            |
| user_id                     | 964aa0854e564db6919c0fc1e14e4dc2                |
| volumes_attached            |                                                 |
+-----------------------------+-------------------------------------------------+
+-----------------------------+-------------------------------------------------+
| Field                       | Value                                           |
+-----------------------------+-------------------------------------------------+
| OS-DCF:diskConfig           | MANUAL                                          |
| OS-EXT-AZ:availability_zone |                                                 |
| OS-EXT-STS:power_state      | NOSTATE                                         |
| OS-EXT-STS:task_state       | scheduling                                      |
| OS-EXT-STS:vm_state         | building                                        |
| OS-SRV-USG:launched_at      | None                                            |
| OS-SRV-USG:terminated_at    | None                                            |
| accessIPv4                  |                                                 |
| accessIPv6                  |                                                 |
| addresses                   |                                                 |
| adminPass                   | xz5sK7hFfy6u                                    |
| config_drive                |                                                 |
| created                     | 2020-07-27T09:39:50Z                            |
| flavor                      | 4c16g30d (a02c754b-dbc9-4db1-afb7-6abb90071f41) |
| hostId                      |                                                 |
| id                          | 1c8ce3b5-b66b-4359-873e-d6c0b8f725ea            |
| image                       |                                                 |
| key_name                    | None                                            |
| name                        | cluster-a389-287mt-master-2                     |
| progress                    | 0                                               |
| project_id                  | 4541cf7e0bf4484b907d0024eb60b327                |
| properties                  | openshiftClusterID='cluster-a389-287mt'         |
| security_groups             | name='default'                                  |
| status                      | BUILD                                           |
| updated                     | 2020-07-27T09:39:50Z                            |
| user_id                     | 964aa0854e564db6919c0fc1e14e4dc2                |
| volumes_attached            |                                                 |
+-----------------------------+-------------------------------------------------+

这些主节点将如何知道如何加入集群并成为控制平面？查看使用--user-data创建时传递给这些文件的点火文件。它告诉RHCOS从何处获取其配置。
[xiwei-redhat.com@bastion ~]$ jq .ignition.config $HOME/openstack-upi/$INFRA_ID-master-0-ignition.json
{
  "append": [
    {
      "source": "https://10.0.0.5:22623/config/master",
      "verification": {}
    }
  ]
}

该源IP当前已映射到引导节点。这意味着这些新的主节点将引导并从引导节点获取其完整配置。这与您在引导节点上必须执行的操作不同，在引导节点上，您必须在其他位置托管更大的点火文件。

现在已创建您的主节点，切换回另一个SSH窗口并观看bootkube进程。从OpenShift 4.5开始，它将大约每5秒检查一次etcd集群是否正常，然后再继续进行引导过程。


===========================================================================================
确认bootstrap的运行
[core@cluster-a389-287mt-bootstrap ~]$ sudo podman images
REPOSITORY                                       TAG      IMAGE ID       CREATED      SIZE
utilityvm.example.com:5000/ocp4/openshift4       <none>   38eeef870804   6 days ago   306 MB
quay.io/openshift-release-dev/ocp-v4.0-art-dev   <none>   39565671f24d   9 days ago   674 MB
quay.io/openshift-release-dev/ocp-v4.0-art-dev   <none>   dc3421f31434   9 days ago   307 MB
quay.io/openshift-release-dev/ocp-v4.0-art-dev   <none>   ce9d81ac0d76   9 days ago   307 MB
quay.io/openshift-release-dev/ocp-v4.0-art-dev   <none>   148721c00154   9 days ago   432 MB
quay.io/openshift-release-dev/ocp-v4.0-art-dev   <none>   1d5c581bdce2   9 days ago   288 MB
quay.io/openshift-release-dev/ocp-v4.0-art-dev   <none>   e719de235c0a   9 days ago   308 MB
quay.io/openshift-release-dev/ocp-v4.0-art-dev   <none>   94a2def5886c   9 days ago   283 MB
quay.io/openshift-release-dev/ocp-v4.0-art-dev   <none>   7259100aac6e   9 days ago   325 MB
quay.io/openshift-release-dev/ocp-v4.0-art-dev   <none>   19409a00c77a   9 days ago   255 MB
quay.io/openshift-release-dev/ocp-v4.0-art-dev   <none>   2cac721193f2   9 days ago   308 MB
quay.io/openshift-release-dev/ocp-v4.0-art-dev   <none>   3dfef7510888   9 days ago   311 MB
quay.io/openshift-release-dev/ocp-v4.0-art-dev   <none>   9129fde41715   9 days ago   305 MB
quay.io/openshift-release-dev/ocp-v4.0-art-dev   <none>   4cde529a7d5e   9 days ago   305 MB
quay.io/openshift-release-dev/ocp-v4.0-art-dev   <none>   b33789fe1572   9 days ago   282 MB
quay.io/openshift-release-dev/ocp-v4.0-art-dev   <none>   3348a05d15b0   9 days ago   382 MB



[xiwei-redhat.com@bastion ~]$  openshift-install wait-for bootstrap-complete --dir $HOME/openstack-upi
INFO Waiting up to 20m0s for the Kubernetes API at https://api.cluster-a389.blue.osp.opentlc.com:6443...

直到：
[xiwei-redhat.com@bastion ~]$ openshift-install wait-for bootstrap-complete --dir $HOME/openstack-upi
INFO Waiting up to 20m0s for the Kubernetes API at https://api.cluster-a389.blue.osp.opentlc.com:6443...
INFO API v1.18.3+3107688 up
INFO Waiting up to 40m0s for bootstrapping to complete...
INFO It is now safe to remove the bootstrap resources
INFO Time elapsed: 5m18s

[xiwei-redhat.com@bastion auth]$ export KUBECONFIG=/home/xiwei-redhat.com/openstack-upi/auth/kubeconfig


xiwei-redhat.com@bastion ~]$ oc get clusterversion
NAME      VERSION   AVAILABLE   PROGRESSING   SINCE   STATUS
version             False       True          14m     Working towards 4.5.3: 62% complete
[xiwei-redhat.com@bastion ~]$


[xiwei-redhat.com@bastion ~]$ oc get clusteroperators
NAME                                       VERSION   AVAILABLE   PROGRESSING   DEGRADED   SINCE
authentication                                       Unknown     Unknown       True       4m11s
cloud-credential                                     True        False         False      15m
cluster-autoscaler
config-operator
console
csi-snapshot-controller
dns                                        4.5.3     True        False         False      2m52s
etcd                                       4.5.3     True        False         False      2m38s
image-registry
ingress
insights
kube-apiserver                             4.5.3     True        True          True       2m7s
kube-controller-manager                    4.5.3     True        True          True       118s
kube-scheduler                             4.5.3     True        True          True       68s
kube-storage-version-migrator              4.5.3     False       False         False      4m12s
machine-api
machine-approver                           4.5.3     True        False         False      2m9s
machine-config                                       False       True          True       4m12s
marketplace
monitoring
network                                    4.5.3     True        False         False      3m39s
node-tuning                                4.5.3     True        False         False      4m11s
openshift-apiserver                        4.5.3     False       False         False      4m10s
openshift-controller-manager                         False       True          False      4m6s
openshift-samples
operator-lifecycle-manager                 4.5.3     True        True          False      3m7s
operator-lifecycle-manager-catalog         4.5.3     True        True          False      3m9s
operator-lifecycle-manager-packageserver             False       True          False      3m7s
service-ca                                 4.5.3     True        False         False      4m
storage



============================================================
 Create Workers 创建worker节点
[xiwei-redhat.com@bastion ~]$ 
for index in $(seq 0 1); do
     openstack port create \
     --network "$GUID-ocp-network" \
     --security-group "$GUID-worker_sg" \
     --allowed-address ip-address=192.168.47.5 \
     --allowed-address ip-address=192.168.47.6 \
     --allowed-address ip-address=192.168.47.7 \
     --tag openshiftClusterID="$INFRA_ID" \
     "$INFRA_ID-worker-port-$index"
 done
+-------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Field                   | Value                                                                                                                                                                               |
+-------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| admin_state_up          | UP                                                                                                                                                                                  |
| allowed_address_pairs   | ip_address='192.168.47.5', mac_address='fa:16:3e:f4:be:6a'                                                                                                                          |
|                         | ip_address='192.168.47.6', mac_address='fa:16:3e:f4:be:6a'                                                                                                                          |
|                         | ip_address='192.168.47.7', mac_address='fa:16:3e:f4:be:6a'                                                                                                                          |
| binding_host_id         | None                                                                                                                                                                                |
| binding_profile         | None                                                                                                                                                                                |
| binding_vif_details     | None                                                                                                                                                                                |
| binding_vif_type        | None                                                                                                                                                                                |
| binding_vnic_type       | normal                                                                                                                                                                              |
| created_at              | 2020-07-27T13:46:03Z                                                                                                                                                                |
| data_plane_status       | None                                                                                                                                                                                |
| description             |                                                                                                                                                                                     |
| device_id               |                                                                                                                                                                                     |
| device_owner            |                                                                                                                                                                                     |
| dns_assignment          | fqdn='host-192-168-47-13.example.com.', hostname='host-192-168-47-13', ip_address='192.168.47.13'                                                                                   |
| dns_domain              |                                                                                                                                                                                     |
| dns_name                |                                                                                                                                                                                     |
| extra_dhcp_opts         |                                                                                                                                                                                     |
| fixed_ips               | ip_address='192.168.47.13', subnet_id='5956d52b-7612-4f5b-9d7b-7924843ea42c'                                                                                                        |
| id                      | c1f0957d-a56a-4e31-93cb-c48766755dce                                                                                                                                                |
| location                | cloud='a389-project', project.domain_id='default', project.domain_name=, project.id='4541cf7e0bf4484b907d0024eb60b327', project.name='a389-project', region_name='regionOne', zone= |
| mac_address             | fa:16:3e:f4:be:6a                                                                                                                                                                   |
| name                    | cluster-a389-fmxsv-worker-port-0                                                                                                                                                    |
| network_id              | 261b4a11-55ac-413b-adb5-357fea543c1a                                                                                                                                                |
| port_security_enabled   | True                                                                                                                                                                                |
| project_id              | 4541cf7e0bf4484b907d0024eb60b327                                                                                                                                                    |
| propagate_uplink_status | None                                                                                                                                                                                |
| qos_policy_id           | None                                                                                                                                                                                |
| resource_request        | None                                                                                                                                                                                |
| revision_number         | 8                                                                                                                                                                                   |
| security_group_ids      | 69218b72-f52a-4fc1-a7b1-03615e2829f5                                                                                                                                                |
| status                  | DOWN                                                                                                                                                                                |
| tags                    | openshiftClusterID=cluster-a389-fmxsv                                                                                                                                               |
| trunk_details           | None                                                                                                                                                                                |
| updated_at              | 2020-07-27T13:46:03Z                                                                                                                                                                |
+-------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
+-------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Field                   | Value                                                                                                                                                                               |
+-------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| admin_state_up          | UP                                                                                                                                                                                  |
| allowed_address_pairs   | ip_address='192.168.47.5', mac_address='fa:16:3e:e2:66:36'                                                                                                                          |
|                         | ip_address='192.168.47.6', mac_address='fa:16:3e:e2:66:36'                                                                                                                          |
|                         | ip_address='192.168.47.7', mac_address='fa:16:3e:e2:66:36'                                                                                                                          |
| binding_host_id         | None                                                                                                                                                                                |
| binding_profile         | None                                                                                                                                                                                |
| binding_vif_details     | None                                                                                                                                                                                |
| binding_vif_type        | None                                                                                                                                                                                |
| binding_vnic_type       | normal                                                                                                                                                                              |
| created_at              | 2020-07-27T13:46:08Z                                                                                                                                                                |
| data_plane_status       | None                                                                                                                                                                                |
| description             |                                                                                                                                                                                     |
| device_id               |                                                                                                                                                                                     |
| device_owner            |                                                                                                                                                                                     |
| dns_assignment          | fqdn='host-192-168-47-29.example.com.', hostname='host-192-168-47-29', ip_address='192.168.47.29'                                                                                   |
| dns_domain              |                                                                                                                                                                                     |
| dns_name                |                                                                                                                                                                                     |
| extra_dhcp_opts         |                                                                                                                                                                                     |
| fixed_ips               | ip_address='192.168.47.29', subnet_id='5956d52b-7612-4f5b-9d7b-7924843ea42c'                                                                                                        |
| id                      | e54d181f-b307-41ef-8325-14265e0341bc                                                                                                                                                |
| location                | cloud='a389-project', project.domain_id='default', project.domain_name=, project.id='4541cf7e0bf4484b907d0024eb60b327', project.name='a389-project', region_name='regionOne', zone= |
| mac_address             | fa:16:3e:e2:66:36                                                                                                                                                                   |
| name                    | cluster-a389-fmxsv-worker-port-1                                                                                                                                                    |
| network_id              | 261b4a11-55ac-413b-adb5-357fea543c1a                                                                                                                                                |
| port_security_enabled   | True                                                                                                                                                                                |
| project_id              | 4541cf7e0bf4484b907d0024eb60b327                                                                                                                                                    |
| propagate_uplink_status | None                                                                                                                                                                                |
| qos_policy_id           | None                                                                                                                                                                                |
| resource_request        | None                                                                                                                                                                                |
| revision_number         | 8                                                                                                                                                                                   |
| security_group_ids      | 69218b72-f52a-4fc1-a7b1-03615e2829f5                                                                                                                                                |
| status                  | DOWN                                                                                                                                                                                |
| tags                    | openshiftClusterID=cluster-a389-fmxsv                                                                                                                                               |
| trunk_details           | None                                                                                                                                                                                |
| updated_at              | 2020-07-27T13:46:09Z                                                                                                                                                                |
+-------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
[xiwei-redhat.com@bastion ~]$ 
for index in $(seq 0 1); do
     openstack server create \
     --image rhcos-ocp45 \
     --flavor 4c16g30d \
     --user-data "$HOME/openstack-upi/worker.ign" \
     --port "$INFRA_ID-worker-port-$index" \
     --property openshiftClusterID="$INFRA_ID" \
     "$INFRA_ID-worker-$index"
 done
+-----------------------------+----------------------------------------------------+
| Field                       | Value                                              |
+-----------------------------+----------------------------------------------------+
| OS-DCF:diskConfig           | MANUAL                                             |
| OS-EXT-AZ:availability_zone |                                                    |
| OS-EXT-STS:power_state      | NOSTATE                                            |
| OS-EXT-STS:task_state       | scheduling                                         |
| OS-EXT-STS:vm_state         | building                                           |
| OS-SRV-USG:launched_at      | None                                               |
| OS-SRV-USG:terminated_at    | None                                               |
| accessIPv4                  |                                                    |
| accessIPv6                  |                                                    |
| addresses                   |                                                    |
| adminPass                   | Buyx8bTjrF6A                                       |
| config_drive                |                                                    |
| created                     | 2020-07-27T13:46:21Z                               |
| flavor                      | 4c16g30d (a02c754b-dbc9-4db1-afb7-6abb90071f41)    |
| hostId                      |                                                    |
| id                          | 91a2a09a-ba4a-43b2-9715-849c2457f43a               |
| image                       | rhcos-ocp45 (e1a13377-2b55-4aee-ba05-0391a53c92e8) |
| key_name                    | None                                               |
| name                        | cluster-a389-fmxsv-worker-0                        |
| progress                    | 0                                                  |
| project_id                  | 4541cf7e0bf4484b907d0024eb60b327                   |
| properties                  | openshiftClusterID='cluster-a389-fmxsv'            |
| security_groups             | name='default'                                     |
| status                      | BUILD                                              |
| updated                     | 2020-07-27T13:46:21Z                               |
| user_id                     | 964aa0854e564db6919c0fc1e14e4dc2                   |
| volumes_attached            |                                                    |
+-----------------------------+----------------------------------------------------+
+-----------------------------+----------------------------------------------------+
| Field                       | Value                                              |
+-----------------------------+----------------------------------------------------+
| OS-DCF:diskConfig           | MANUAL                                             |
| OS-EXT-AZ:availability_zone |                                                    |
| OS-EXT-STS:power_state      | NOSTATE                                            |
| OS-EXT-STS:task_state       | scheduling                                         |
| OS-EXT-STS:vm_state         | building                                           |
| OS-SRV-USG:launched_at      | None                                               |
| OS-SRV-USG:terminated_at    | None                                               |
| accessIPv4                  |                                                    |
| accessIPv6                  |                                                    |
| addresses                   |                                                    |
| adminPass                   | nATsW4NYigRo                                       |
| config_drive                |                                                    |
| created                     | 2020-07-27T13:46:32Z                               |
| flavor                      | 4c16g30d (a02c754b-dbc9-4db1-afb7-6abb90071f41)    |
| hostId                      |                                                    |
| id                          | c7ced2b0-33f1-4b03-bb9b-896dd1acb421               |
| image                       | rhcos-ocp45 (e1a13377-2b55-4aee-ba05-0391a53c92e8) |
| key_name                    | None                                               |
| name                        | cluster-a389-fmxsv-worker-1                        |
| progress                    | 0                                                  |
| project_id                  | 4541cf7e0bf4484b907d0024eb60b327                   |
| properties                  | openshiftClusterID='cluster-a389-fmxsv'            |
| security_groups             | name='default'                                     |
| status                      | BUILD                                              |
| updated                     | 2020-07-27T13:46:32Z                               |
| user_id                     | 964aa0854e564db6919c0fc1e14e4dc2                   |
| volumes_attached            |                                                    |
+-----------------------------+----------------------------------------------------+
[xiwei-redhat.com@bastion ~]$ jq .ignition.config $HOME/openstack-upi/worker.ign
{
  "append": [
    {
      "source": "https://192.168.47.5:22623/config/worker",
      "verification": {}
    }
  ]
}




[xiwei-redhat.com@bastion ~]$  oc adm certificate approve csr-bt47h csr-kgbq2
certificatesigningrequest.certificates.k8s.io/csr-bt47h approved
certificatesigningrequest.certificates.k8s.io/csr-kgbq2 approved
[xiwei-redhat.com@bastion ~]$ oc get csr
NAME        AGE   SIGNERNAME                                    REQUESTOR                                                                   CONDITION
csr-4mwxt   22m   kubernetes.io/kube-apiserver-client-kubelet   system:serviceaccount:openshift-machine-config-operator:node-bootstrapper   Approved,Issued
csr-765fh   22m   kubernetes.io/kube-apiserver-client-kubelet   system:serviceaccount:openshift-machine-config-operator:node-bootstrapper   Approved,Issued
csr-8c4zl   21m   kubernetes.io/kubelet-serving                 system:node:cluster-a389-fmxsv-master-1                                     Approved,Issued
csr-8wtpm   23m   kubernetes.io/kubelet-serving                 system:node:cluster-a389-fmxsv-master-0                                     Approved,Issued
csr-bt47h   76s   kubernetes.io/kube-apiserver-client-kubelet   system:serviceaccount:openshift-machine-config-operator:node-bootstrapper   Approved,Issued
csr-kgbq2   56s   kubernetes.io/kube-apiserver-client-kubelet   system:serviceaccount:openshift-machine-config-operator:node-bootstrapper   Approved,Issued
csr-nfkzc   22m   kubernetes.io/kubelet-serving                 system:node:cluster-a389-fmxsv-master-2                                     Approved,Issued
csr-q2flt   23m   kubernetes.io/kube-apiserver-client-kubelet   system:serviceaccount:openshift-machine-config-operator:node-bootstrapper   Approved,Issued



[xiwei-redhat.com@bastion ~]$ oc get nodes
NAME                          STATUS   ROLES    AGE    VERSION
cluster-a389-fmxsv-master-0   Ready    master   24m    v1.18.3+3107688
cluster-a389-fmxsv-master-1   Ready    master   23m    v1.18.3+3107688
cluster-a389-fmxsv-master-2   Ready    master   24m    v1.18.3+3107688
cluster-a389-fmxsv-worker-0   Ready    worker   102s   v1.18.3+3107688
cluster-a389-fmxsv-worker-1   Ready    worker   103s   v1.18.3+3107688




=============================================================
 Configure Registry Storage  配置镜像仓库存储

删除旧的存储
[xiwei-redhat.com@bastion ~]$  oc project openshift-image-registry
Now using project "openshift-image-registry" on server "https://api.cluster-a389.blue.osp.opentlc.com:6443".
[xiwei-redhat.com@bastion ~]$ oc get pvc
NAME                     STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
image-registry-storage   Bound    pvc-8a36227c-09b3-4d61-9f80-bdbb660e85a2   100Gi      RWO            standard       20m
[xiwei-redhat.com@bastion ~]$ oc get pv
NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                                             STORAGECLASS   REASON   AGE
pvc-8a36227c-09b3-4d61-9f80-bdbb660e85a2   100Gi      RWO            Delete           Bound    openshift-image-registry/image-registry-storage   standard                3m59s
[xiwei-redhat.com@bastion ~]$ oc delete pvc image-registry-storage
persistentvolumeclaim "image-registry-storage" deleted
oc patch configs.imageregistry.operator.openshift.io cluster --type merge -p '{"spec":{"replicas":0}}'


创建新的存储：
[xiwei-redhat.com@bastion ~]$ cat $HOME/resources/pv-registry.yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: registry-storage
spec:
  capacity:
    storage: 100Gi
  accessModes:
  - ReadWriteMany
  nfs:
    path: /ocp-registry
    server: utilityvm.example.com
  persistentVolumeReclaimPolicy: Recycle
  storageClassName: nfs

[xiwei-redhat.com@bastion ~]$ cat $HOME/resources/pvc-registry.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: image-registry-storage
  namespace: openshift-image-registry
spec:
  accessModes:
  - ReadWriteMany
  resources:
    requests:
      storage: 100Gi
  storageClassName: nfs
  volumeMode: Filesystem

[xiwei-redhat.com@bastion ~]$ oc create -f $HOME/resources/pv-registry.yaml
persistentvolume/registry-storage created
[xiwei-redhat.com@bastion ~]$ oc create -f $HOME/resources/pvc-registry.yaml
persistentvolumeclaim/image-registry-storage created


将Image Registry扩展到两个副本。
$ oc patch configs.imageregistry.operator.openshift.io cluster --type merge -p '{"spec":{"replicas":2}}'

oc get pods -o wide -n openshift-image-registry
NAME                                              READY   STATUS      RESTARTS   AGE   IP              NODE                          NOMINATED NODE   READINESS GATES
cluster-image-registry-operator-b466c78bd-9bb59   2/2     Running     0          53m   10.129.0.17     cluster-625c-xx7tn-master-2   <none>           <none>
image-pruner-1595548800-br25g                     0/1     Completed   0          14m   10.128.2.5      cluster-625c-xx7tn-worker-0   <none>           <none>
image-registry-5fc95665c-6qklv                    1/1     Running     0          48s   10.128.2.6      cluster-625c-xx7tn-worker-0   <none>           <none> 
image-registry-5fc95665c-7gf28                    1/1     Running     0          48s   10.131.0.24     cluster-625c-xx7tn-worker-1   <none>           <none> 
node-ca-brjfw                                     1/1     Running     0          33m   192.168.47.19   cluster-625c-xx7tn-worker-0   <none>           <none>
node-ca-nh4vh                                     1/1     Running     0          53m   192.168.47.30   cluster-625c-xx7tn-master-1   <none>           <none>
node-ca-pcwjf                                     1/1     Running     0          53m   192.168.47.14   cluster-625c-xx7tn-master-2   <none>           <none>
node-ca-sdjs7                                     1/1     Running     0          53m   192.168.47.13   cluster-625c-xx7tn-master-0   <none>           <none>
node-ca-vbcbc                                     1/1     Running     0          35m   192.168.47.26   cluster-625c-xx7tn-worker-1   <none>           <none>


最后查看所有co状态：
[xiwei-redhat.com@bastion ~]$ oc get co
NAME                                       VERSION   AVAILABLE   PROGRESSING   DEGRADED   SINCE
authentication                             4.5.3     True        False         False      5m46s
cloud-credential                           4.5.3     True        False         False      48m
cluster-autoscaler                         4.5.3     True        False         False      25m
config-operator                            4.5.3     True        False         False      26m
console                                    4.5.3     True        False         False      11m
csi-snapshot-controller                    4.5.3     True        False         False      14m
dns                                        4.5.3     True        False         False      36m
etcd                                       4.5.3     True        False         False      36m
image-registry                             4.5.3     True        False         False      14m
ingress                                    4.5.3     True        False         False      14m
insights                                   4.5.3     True        False         False      31m
kube-apiserver                             4.5.3     True        False         False      35m
kube-controller-manager                    4.5.3     True        False         False      35m
kube-scheduler                             4.5.3     True        False         False      34m
kube-storage-version-migrator              4.5.3     True        False         False      14m
machine-api                                4.5.3     True        False         False      27m
machine-approver                           4.5.3     True        False         False      35m
machine-config                             4.5.3     True        False         False      20m
marketplace                                4.5.3     True        False         False      30m
monitoring                                 4.5.3     True        False         False      13m
network                                    4.5.3     True        False         False      37m
node-tuning                                4.5.3     True        False         False      37m
openshift-apiserver                        4.5.3     True        False         False      32m
openshift-controller-manager               4.5.3     True        False         False      30m
openshift-samples                          4.5.3     True        False         False      25m
operator-lifecycle-manager                 4.5.3     True        False         False      36m
operator-lifecycle-manager-catalog         4.5.3     True        False         False      36m
operator-lifecycle-manager-packageserver   4.5.3     True        False         False      32m
service-ca                                 4.5.3     True        False         False      37m
storage                                    4.5.3     True        False         False      31m

